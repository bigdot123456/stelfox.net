<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>pfSense and Gaming - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    <meta name="keywords" content="gaming, networking, pfsense />

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="pfSense and Gaming" />
    <meta property="og:url" content="https://stelfox.net/blog/2010/03/pfsense-and-gaming/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <div class='post'>
        <h1><a href="/blog/2010/03/pfsense-and-gaming/">pfSense and Gaming</a></h1>
        <aside class="post-date">Published <time datetime=''>after his first cup of coffee on March 24, 2010</time> by Sam Stelfox</aside>
        <article>
          <p>Previously while reviewing open source firewall distributions (which I never
finished), I mentioned some gaming issues. I found a solution that seems to fix
all the issues I had with gaming but unfortunately creates a few new issues
that I didn&#39;t arise. The issue lies with how pfSense performs NAT&#39;ing.</p>

<p>The ports that a particular client opens under some cases can be easily
predicted and in turn exploited. To prevent this pfSense randomizes the
external port that traffic is coming from. This is perfectly fine for any
application that follows networking standards. However it seems that games such
as Call of Duty and Company of Heroes passes the port they open inside their
network protocol which is what the game servers then use to connect back to
them rather than looking at the actual frames that arrive from the client. This
means that the server will be trying to connect back on the wrong port as
pfSense has changed it.</p>

<p>I can see some impossibly small security benefits for the game programmers to
do this. I&#39;m guessing more likely than not this was a failing of the network
library they use where they don&#39;t have access to the information in the frames
of the packets so they wrote a work around for it, and in turn violate basic
network programming best practices.</p>

<p>So what&#39;s the solution? I strongly recommend that anyone reading this read the
complete article as it is possible to prevent yourself from being able to use
your network connection behind pfSense. If any setting doesn&#39;t look quite like
I describe it your probably using a different version and should consult with
the good people in the IRC channels or in their forums.</p>

<p>Here are the steps to get it to work:</p>

<ol>
<li>Open up Firewall -&gt; NAT</li>
<li>There should be three tabs, &#39;Port Forward&#39;, &#39;1:1&#39;, and &#39;Outbound&#39;</li>
<li>Click on the &#39;Outbound&#39; tab</li>
<li>There should be two radio buttons, by default &quot;Automatic outbound NAT rule
generation (IPsec passthrough)&quot; is selected. Choose &quot;Manual Outbound NAT
rule generation (Advanced Outbound NAT (AON))&quot;</li>
<li>Verify that there is a mapping with the following settings:

<ul>
<li>Interface: WAN</li>
<li>Source: Your internal (LAN) subnet</li>
<li>Source Port: *</li>
<li>Destination: *</li>
<li>Destination Port: *</li>
<li>NAT Address: *</li>
<li>NAT Port: *</li>
<li>Static Port: YES</li>
</ul></li>
<li>If you have more than one subnet you&#39;ll need to do this for each one.</li>
<li>Save and Apply the settings</li>
</ol>

<p>That should be it, there has only been two issues that I&#39;ve found, one I&#39;m not
really sure if it&#39;s related. About the same time as when I made this change
UPnP broke. I&#39;m not sure why but it&#39;s something that seems to break quite a bit
with pfSense and I can see this being related to NAT&#39;ing.</p>

<p>The second issue is traffic in between subnets. While it seems to mostly work,
there have been a few oddities such as a computer on one subnet is able to talk
to a computer on a different subnet as long as it initiates the connection. If
the other computer trys to initiate the connection then it will just time out.
It definitely wasn&#39;t related to firewall rules (I set an allow all on both
interfaces and turned off the firewall on both computers). Switching back to
auto-nat&#39;ing resolved the issue.</p>

        </article>
      </div>
    </div>
  </body>
</html>
