<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>CarrierWave, S3 and Filenames - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    <meta name="keywords" content="development, ruby, websites />

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="CarrierWave, S3 and Filenames" />
    <meta property="og:url" content="https://stelfox.net/blog/2012/08/carrierwave-s3-and-filenames/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <div class='post'>
        <h1><a href="/blog/2012/08/carrierwave-s3-and-filenames/">CarrierWave, S3 and Filenames</a></h1>
        <aside class="post-date">Published <time datetime=''>instead of an afternoon nap on August 9, 2012</time> by Sam Stelfox</aside>
        <article>
          <p>This is going to be a real quick post. I&#39;m using the &quot;carrier_wave&quot; gem with
&quot;fog&quot; for one of my projects and found that when a file is stored on S3 the
&quot;identifier&quot;, and &quot;filename&quot; methods return nil. I got around this issue in two
separate ways neither of which I&#39;m particularly happy about.</p>

<p>Outside of the uploader, you can use the File utility and the URL of the object
to get the base filename like so:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="constant">File</span>.basename(<span class="constant">Model</span>.asset.url)
</pre></div>
</div>

<p>If you try and do this within the uploader itself like this:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="constant">File</span>.basename(<span class="predefined-constant">self</span>.url)
</pre></div>
</div>

<p>It will work, but not when creating additional versions such as thumbnails as
the file hasn&#39;t actually been created yet so a URL can&#39;t be built and you&#39;ll
get an error trying to perform File.basename(nil). You&#39;d need to go back up to
the model and get the normal version&#39;s URL like so:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="constant">File</span>.basename(<span class="predefined-constant">self</span>.model.asset.url)
</pre></div>
</div>

<p>Now if you&#39;re trying to get the file name to build part of the store_dir,
you&#39;ve just created an infinite loop! Ruby will be happy to tell you that the
stack level too deep (SystemStackError). So ultimately how did I end up getting
it into my store_dir?</p>
<div class="CodeRay">
  <div class="code"><pre><span class="predefined-constant">self</span>.model.attributes[<span class="string"><span class="delimiter">&quot;</span><span class="content">asset</span><span class="delimiter">&quot;</span></span>]
</pre></div>
</div>

<p>The file name gets stored raw directly in the database, and thus you can pull
it out by accessing the value directly without going through the accessor that
get overridden by CarrierWave. I&#39;m pretty sure this is a bug, and will report
it with example code and a test (as is appropriate for any bug report <em>hint</em>)
as soon as my dead line has passed.</p>

        </article>
      </div>
    </div>
  </body>
</html>
