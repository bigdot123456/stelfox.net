<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Adding a table prefix to DataMapper tables - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    <meta name="keywords" content="development, ruby />

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Adding a table prefix to DataMapper tables" />
    <meta property="og:url" content="https://stelfox.net/blog/2012/08/adding-a-table-prefix-to-datamapper-tables/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <div class='post'>
        <h1><a href="/blog/2012/08/adding-a-table-prefix-to-datamapper-tables/">Adding a table prefix to DataMapper tables</a></h1>
        <aside class="post-date">Published <time datetime=''>after his first cup of coffee on August 7, 2012</time> by Sam Stelfox</aside>
        <article>
          <p>So I recently encountered a situation where I needed to define a prefix on the
tables used by the &quot;data_mapper&quot; gem. When I went searching I found quite a bit
of information about similar projects in Python, and PHP named DataMapper but
nothing about the ruby &quot;data_mapper&quot;. The search continued eventually ending in
my reading through the source of the data_mapper gem only to find that there
was no feature for simply defining a prefix.</p>

<p>Reading through the source though did allow me to find any easy way to
implement such functionality. The following snippet is a minimalistic
data_mapper initialization and setup of one model with a table prefix of
&quot;source_&quot; (chosen at random and of no significance).</p>
<div class="CodeRay">
  <div class="code"><pre><span class="comment"># encoding: utf-8</span>

<span class="comment"># (1)</span>
require <span class="string"><span class="delimiter">&quot;</span><span class="content">dm-core</span><span class="delimiter">&quot;</span></span>
require <span class="string"><span class="delimiter">&quot;</span><span class="content">dm-migrations</span><span class="delimiter">&quot;</span></span>

<span class="comment"># (2)</span>
<span class="keyword">module</span> <span class="class">PrefixNamingConvention</span>
  <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">call</span>(model_name)
    <span class="comment"># (3)</span>
    prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">source_</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># (4)</span>
    table_name = <span class="constant">DataMapper</span>::<span class="constant">NamingConventions</span>::<span class="constant">Resource</span>::<span class="constant">UnderscoredAndPluralized</span>.call(model_name)

    <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">#{</span>prefix<span class="inline-delimiter">}</span></span><span class="inline"><span class="inline-delimiter">#{</span>table_name<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment"># (5)</span>
<span class="constant">DataMapper</span>::<span class="constant">Logger</span>.new(<span class="global-variable">$stdout</span>, <span class="symbol">:debug</span>)

<span class="comment"># (6)</span>
<span class="constant">DataMapper</span>.setup(<span class="symbol">:default</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">sqlite:example.db</span><span class="delimiter">&quot;</span></span>)
<span class="constant">DataMapper</span>.repository(<span class="symbol">:default</span>).adapter.resource_naming_convention = <span class="constant">PrefixNamingConvention</span>

<span class="comment"># (7)</span>
<span class="keyword">class</span> <span class="class">Person</span>
  include <span class="constant">DataMapper</span>::<span class="constant">Resource</span>

  property <span class="symbol">:id</span>, <span class="constant">Serial</span>
  property <span class="symbol">:first_name</span>, <span class="constant">String</span>
  property <span class="symbol">:last_name</span>, <span class="constant">String</span>
  property <span class="symbol">:email</span>, <span class="constant">String</span>
<span class="keyword">end</span>

<span class="comment"># (8)</span>
<span class="constant">DataMapper</span>.finalize
<span class="constant">DataMapper</span>.auto_upgrade!
</pre></div>
</div>

<p>So here are some notes on what&#39;s going on in this snippet. Each area that I
will be discussing has been annotated with a number like &quot;# (1)&quot; to make it
easier to find a section you have questions about.</p>

<ol>
<li>Since this is an example I&#39;m only including the bare minimum data mapper
gems to accomplish the task. If you&#39;re using bundler you may need to also
require &quot;rubygems&quot; to get this too work.</li>
<li>This is where the real work happens, DataMapper uses external modules that
receive the &quot;call&quot; method to handle the conversion of class names to table
names. By default DataMapper uses the module
&quot;DataMapper::NamingConventions::Resource::UnderscoredAndPluralized&quot;, which
I&#39;ll use later to maintain the same names.</li>
<li>This is where I&#39;m defining the table prefix. This could be defined in a
global, call another method or class, whatever your heart desires to get a
string that will be used as a prefix.</li>
<li>Here I&#39;m getting what DataMapper would have named the table if I wasn&#39;t
interferring</li>
<li>I&#39;m logging to standard out so that I can see the queries called to verify
that DataMapper is creating tables with the names that I want. This is used
later on in this post to demonstrate this solution working, however, it
could be left out without affecting anything.</li>
<li>Initial setup of a sqlite database, and then the good stuff. Once a database
has been setup with a specific adapter you can change the naming convention
DataMapper will use to generate table names. This is accomplished by passing
the module constant name through the repositories adapter and too
&quot;resource_naming_convention&quot; as demonstrated in the code.</li>
<li>Here I&#39;m defining an example model of no importance. This is purely for
demonstration, normally DataMapper would name this model &quot;people&quot;.</li>
<li>Inform DataMapper we&#39;re done setting it up and to run the migrations to
create the model defined.</li>
</ol>

<p>When you run this ruby file (assuming you have the &quot;data_mapper&quot; and
&quot;dm-sqlite-adapter&quot; gem installed) you&#39;ll see output very similar too this:</p>
<div class="CodeRay">
  <div class="code"><pre>~ (0.001402) PRAGMA table_info(&quot;source_people&quot;)
~ (0.000089) SELECT sqlite_version(*)
~ (0.077840) CREATE TABLE &quot;source_people&quot; (&quot;id&quot; INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, &quot;first_name&quot; VARCHAR(50), &quot;last_name&quot; VARCHAR(50), &quot;email&quot; VARCHAR(50))
</pre></div>
</div>

<p>Notice the third line? Specifically the name of the table? It&#39;s named exactly
as it would have been except now it has a prefix of &quot;source_&quot;.</p>

<p>Hope this saves someone else some trouble. Cheers!</p>

        </article>
      </div>
    </div>
  </body>
</html>
