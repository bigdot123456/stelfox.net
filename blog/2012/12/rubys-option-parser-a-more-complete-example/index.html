<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Ruby's Option Parser - a More Complete Example - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    <meta name="keywords" content="ruby, cli />

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Ruby's Option Parser - a More Complete Example" />
    <meta property="og:url" content="https://stelfox.net/blog/2012/12/rubys-option-parser-a-more-complete-example/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <div class='post'>
        <h1><a href="/blog/2012/12/rubys-option-parser-a-more-complete-example/">Ruby's Option Parser - a More Complete Example</a></h1>
        <aside class="post-date">Published <time datetime=''>in the middle of the night on December 2, 2012</time> by Sam Stelfox</aside>
        <article>
          <p>Recently while writing a Ruby program I needed to parse some command line
options. Helpfully Ruby provides a module named OptionParser to make this easy.
I found a few parts of the documentation ambiguous and a few others down right
confusing.</p>

<p>The catch I hit was the required field. In my mind the definition of a required
argument is something that needs to be passed on the commandline to continue.
What OptionParser actually means is that a value isn&#39;t required when the
argument is passed. OptionParser already provides boolean switches, so when
someone would use an optional switch is beyond me.</p>

<p>To make it a little more clear and to have something to work from in the future
I created the following chunk of code that includes a Configuration singleton
that can be used anywhere within your codebase to access the run-time
configuration, a sample parser with a wide range of different types of options,
and it will load configuration from a file named config.yml in the same
directory.</p>

<p>I feel like the following is a much more complete explanation of how
OptionParser is supposed to be used with supporting code.</p>
<div class="CodeRay">
  <div class="code"><pre><span class="doctype">#!/usr/bin/env ruby</span>

<span class="comment"># This file provides an example of creating a command line application with a</span>
<span class="comment"># wide variety of command line options, parsing and the like as well as global</span>
<span class="comment"># configuration singleton that can be relied on throughout a program.</span>
<span class="comment">#</span>
<span class="comment"># This entire setup lives within the &quot;Example&quot; module. These are really common</span>
<span class="comment"># names and it would be a shame to override required functionality in other code</span>
<span class="comment"># that wasn't properly namespaced.</span>

require <span class="string"><span class="delimiter">'</span><span class="content">optparse</span><span class="delimiter">'</span></span>
require <span class="string"><span class="delimiter">'</span><span class="content">singleton</span><span class="delimiter">'</span></span>
require <span class="string"><span class="delimiter">'</span><span class="content">yaml</span><span class="delimiter">'</span></span>

<span class="keyword">module</span> <span class="class">Example</span>
  <span class="comment"># Defines the available configuration options for the configuration</span>
  <span class="constant">ConfigurationStruct</span> = <span class="constant">Struct</span>.new(<span class="symbol">:enum</span>, <span class="symbol">:list</span>, <span class="symbol">:required</span>, <span class="symbol">:optional</span>, <span class="symbol">:verbose</span>, <span class="symbol">:float</span>)

  <span class="keyword">class</span> <span class="class">Configuration</span>
    include <span class="constant">Singleton</span>

    <span class="comment"># Initialize the configuration and set defaults:</span>
    <span class="class-variable">@@config</span> = <span class="constant">ConfigurationStruct</span>.new

    <span class="comment"># This is where the defaults are being set</span>
    <span class="class-variable">@@config</span>.enum = <span class="symbol">:one</span>
    <span class="class-variable">@@config</span>.list = []
    <span class="class-variable">@@config</span>.optional = <span class="predefined-constant">nil</span>
    <span class="class-variable">@@config</span>.verbose = <span class="predefined-constant">false</span>

    <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">config</span>
      <span class="keyword">yield</span>(<span class="class-variable">@@config</span>) <span class="keyword">if</span> block_given?
      <span class="class-variable">@@config</span>
    <span class="keyword">end</span>

    <span class="comment"># Loads a YAML configuration file and sets each of the configuration values to</span>
    <span class="comment"># whats in the file.</span>
    <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">load</span>(file)
      <span class="constant">YAML</span>::load_file(file).each <span class="keyword">do</span> |key, value|
        <span class="predefined-constant">self</span>.send(<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">#{</span>key<span class="inline-delimiter">}</span></span><span class="content">=</span><span class="delimiter">&quot;</span></span>, value)
      <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment"># This provides an easy way to dump the configuration as a hash</span>
    <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">to_hash</span>
      <span class="constant">Hash</span>[<span class="class-variable">@@config</span>.each_pair.to_a]
    <span class="keyword">end</span>

    <span class="comment"># Pass any other calls (most likely attribute setters/getters on to the</span>
    <span class="comment"># configuration as a way to easily set/get attribute values </span>
    <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">method_missing</span>(method, *args, &amp;block)
      <span class="keyword">if</span> <span class="class-variable">@@config</span>.respond_to?(method)
        <span class="class-variable">@@config</span>.send(method, *args, &amp;block)
      <span class="keyword">else</span>
        raise <span class="constant">NoMethodError</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment"># Handles validating the configuration that has been loaded/configured</span>
    <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">validate!</span>
      valid = <span class="predefined-constant">true</span>

      valid = <span class="predefined-constant">false</span> <span class="keyword">if</span> <span class="constant">Configuration</span>.required.nil?

      raise <span class="constant">ArgumentError</span> <span class="keyword">unless</span> valid
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">class</span> <span class="class">ConfigurationParser</span>
    <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">parse</span>(args)
      opts = <span class="constant">OptionParser</span>.new <span class="keyword">do</span> |parser|

        parser.separator <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        parser.separator <span class="string"><span class="delimiter">&quot;</span><span class="content">Specific options:</span><span class="delimiter">&quot;</span></span>

        parser.on(<span class="string"><span class="delimiter">&quot;</span><span class="content">--enum ENUM</span><span class="delimiter">&quot;</span></span>, [<span class="symbol">:one</span>, <span class="symbol">:two</span>, <span class="symbol">:three</span>], <span class="string"><span class="delimiter">&quot;</span><span class="content">This field requires one of a set of predefined values be</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">set. If wrapped in brackets this option can be set to nil.</span><span class="delimiter">&quot;</span></span>) <span class="keyword">do</span> |setting|
          <span class="constant">Configuration</span>.enum = setting
        <span class="keyword">end</span>

        parser.on(<span class="string"><span class="delimiter">&quot;</span><span class="content">-l</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--list x,y</span><span class="delimiter">&quot;</span></span>, <span class="constant">Array</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">This command flag takes a comma separated list (without</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">spaces) of values and turns it into an array. This requires</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">at least one argument.</span><span class="delimiter">&quot;</span></span>) <span class="keyword">do</span> |setting|
          <span class="constant">Configuration</span>.list = setting
        <span class="keyword">end</span>

        parser.on(<span class="string"><span class="delimiter">&quot;</span><span class="content">--[no-]verbose</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">This is a common boolean flag, setting verbosity to either</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">true or false.</span><span class="delimiter">&quot;</span></span>) <span class="keyword">do</span> |setting|
          <span class="constant">Configuration</span>.verbose = setting
        <span class="keyword">end</span>

        parser.on(<span class="string"><span class="delimiter">&quot;</span><span class="content">--optional [STR]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">This command doesn't require a string to be passed to it, if</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">nothing is passed it will be nil. No error will be raised if</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">nothing is passed to it that logic needs to be handled</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">yourself.</span><span class="delimiter">&quot;</span></span>) <span class="keyword">do</span> |setting|
          <span class="constant">Configuration</span>.optional = setting
        <span class="keyword">end</span>

        parser.on(<span class="string"><span class="delimiter">&quot;</span><span class="content">-r</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--required STR</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">This command requires a string to be passed to it.</span><span class="delimiter">&quot;</span></span>) <span class="keyword">do</span> |setting|
          <span class="constant">Configuration</span>.required = setting
        <span class="keyword">end</span>

        parser.on(<span class="string"><span class="delimiter">&quot;</span><span class="content">--float NUM</span><span class="delimiter">&quot;</span></span>, <span class="constant">Float</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">This command will only accept an integer or a float.</span><span class="delimiter">&quot;</span></span>) <span class="keyword">do</span> |setting|
          <span class="constant">Configuration</span>.float = setting
        <span class="keyword">end</span>

        parser.on_tail(<span class="string"><span class="delimiter">&quot;</span><span class="content">-h</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--help</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--usage</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Show this usage message and quit.</span><span class="delimiter">&quot;</span></span>) <span class="keyword">do</span> |setting|
          puts parser.help
          exit
        <span class="keyword">end</span>

        parser.on_tail(<span class="string"><span class="delimiter">&quot;</span><span class="content">-v</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--version</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Show version information about this program and quit.</span><span class="delimiter">&quot;</span></span>) <span class="keyword">do</span>
          puts <span class="string"><span class="delimiter">&quot;</span><span class="content">Option Parser Example v1.0.0</span><span class="delimiter">&quot;</span></span>
          exit
        <span class="keyword">end</span>
      <span class="keyword">end</span>

      opts.parse!(args)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">if</span> <span class="constant">File</span>.exists?(<span class="string"><span class="delimiter">&quot;</span><span class="content">config.yml</span><span class="delimiter">&quot;</span></span>)
  <span class="constant">Example</span>::<span class="constant">Configuration</span>.load(<span class="string"><span class="delimiter">&quot;</span><span class="content">config.yml</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">end</span>

<span class="constant">Example</span>::<span class="constant">ConfigurationParser</span>.parse(<span class="predefined-constant">ARGV</span>)
<span class="constant">Example</span>::<span class="constant">Configuration</span>.validate!

require <span class="string"><span class="delimiter">&quot;</span><span class="content">json</span><span class="delimiter">&quot;</span></span>
puts <span class="constant">JSON</span>.pretty_generate(<span class="constant">Example</span>::<span class="constant">Configuration</span>.to_hash)
</pre></div>
</div>

        </article>
      </div>
    </div>
  </body>
</html>
