---
created_at: 2010-06-30 16:11:24+00:00
updated_at: 2010-06-30 16:11:24+00:00
type: post
kind: article
layout: blog_post
title: 'A Little Surprise Nestled Among Software'
---

So yesterday my morning started out by my organization's WAN administrator
pointing out some weird https traffic coming from one of our building's
subnets. I looked and sure enough there was a steadily growing stream of https
traffic coming from there. There was a few offices in that building and several
labs that weren't being used for the summer. Definitely not enough people to be
downloading the 10Mb/s and growing stream of information.

My first thought was virus outbreak. Using the net flows generated by the
building's head switch I watched as dozens of computers created https
connections to an IP address block owned by a German telecom. Another red flag.
The entire lab seemed to have  it.

There were no PTR records to indicate any kind of legitimate service  running
on the IPs they were connecting to. Great. That lab had just been ghosted with
an image so the master must have it. Sure enough the master was making the same
connections. I blocked all https traffic on that subnet and went about digging
deeper into the infection.

This is where I'm going to go on a bit of a tangent rant. Windows UAC. The labs
have all had Windows 7 Enterprise deployed to them and for security reasons we
left UAC on. It's annoying but for the most part it's a good security addition
to Windows, with the exception of use cases beyond how the developers use their
machines...

I'm far more comfortable doing everything on a computer from a keyboard, even
in Windows. It's quite rare for me to use the mouse unless I'm playing a game,
doing image manipulation or browsing the web. So when I open a command prompt
from and administrator account and run a command that gets stopped by UAC I
expect the same prompt I would for any program that I tried to run using
Window's GUI or a Windows equivalent of the venerable sudo utility.

You have to start the command prompt with Administrator privileges which
involves navigating through a context menu in a context menu in a context menu
(the right click menu, in the accessories folder menu, in the programs
menu...). Alternatively you can make it so the command prompt always starts
with Administrator privileges, but I don't always need them and don't want them
when I don't need them.

If this was limited to the command prompt I wouldn't be as bothered, but it
does the same damn thing from the run prompt. Rather than popping up a dialog
box to confirm an action Windows will immediately deny the ability to run the
program and you're left navigating menus (or in the case of the group policy
editor, traversing Window's folder structure to find the executable so you can
right click on the damn thing).

Moving on... a quick run of netstat showed the connection attempts to the
foreign servers stuck in a SYN_SENT mode. Good, it wasn't talking to anyone any
more and the subnet's traffic graph reflected that. I ran "netstat -b" to find
out what program was creating the connection. "Akamai".

I know that sounded familiar. I vaguely remembered it having to do with DNS and
connecting user's to the closest server to deliver content but that didn't
involve a client and definitely wasn't as noisy or as obnoxious as this thing.
So where was it? Well no one was logged into any of the computers while this
was happening so it was running before login so probably snuck itself in as a
service.

Usually I'd just jump straight to the registry to try and find this kind of
thing but I already had the computer management window open so I took a quick
peek at the service listing. Right nr the top "Akamai NetSession Interface" was
set to start on boot. Bingo, but this looked some what legitimate. We didn't
willingly install this, but it had all the signs of professionally made
software and wasn't trying to hide itself beyond not being listed as an
installed program.

I shutdown all the computers on the subnet and went looking for answers.
Apparently Akamai has started a service that allows companies to cache content
used by their programs on user's local machines.

We didn't want this software, it's using a lot of traffic, and nowhere were we
told that it would also be installed or what the ramifications would be.
Regardless of what the company wants to call this, it's malware as far as I'm
concerned even if it the software wasn't designed with a malicious intent it
was consuming large amounts of resources that we didn't willingly give it.

All the software on the lab machines was there for a reason, and it wasn't
obvious which of the pieces of software it came with. Without knowing where it
came from, I know that simply removing it from the computers wouldn't be enough
to stop it from coming back. I couldn't block the traffic as it was using
standards compliant https connections.

Disabling the service seemed to do the trick so I wrote a quick Administrative
Template for GPO that I could deploy across our domain to permanently disable
the service on any machine that was unfortunate enough to get this nasty thing.
If your familiar with GPO's and Administrative Templates here is the source of
mine that I used to manage this damn service:

```
CLASS MACHINE
CATEGORY !!SystemOnly
  POLICY !!PolicyName
    KEYNAME "SYSTEM\CurrentControlSet\Services\Akamai"
    PART !!PartName DROPDOWNLIST REQUIRED
      VALUENAME "Start"
      ITEMLIST
        NAME "Automatic" VALUE NUMERIC 1
        NAME "Manual" VALUE NUMERIC 3
        NAME "Disabled" VALUE NUMERIC 4 DEFAULT
      END ITEMLIST
    END PART
  END POLICY
END CATEGORY

[strings]
SystemOnly="System"
PolicyName="Akamai NetSession Interface"
PartName="Akamai NetSession Interface Service Status"</code>
```

After enabling the policy and a couple of reboots later and the traffic was
gone. I personally despise any company that installs anything other than what
you want. It's just bad practice. If you have to hide it, your users probably
don't want it. Don't piss off your user base, that's just bad for business.

