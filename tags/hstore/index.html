<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Hstore - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Hstore" />
    <meta property="og:url" content="https://stelfox.net/tags/hstore/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git io:repos/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <div class="post">
  <h1>Hstore</h1>
  
    <div class='post'>
      <h2><a href="/blog/2014/05/pg-error-error-type-hstore-does-not-exist/">PG::Error: ERROR: Type 'Hstore' Does Not Exist</a></h1>
      <aside>Posted at: 2014-05-28 18:00:55 -0400</aside>
      <article>
        <p>I&#39;ve been using the PostgreSQL&#39;s hstore extension in a Rails application lately
and kept encountering the error that is this post&#39;s namesake. It would
specifically happen when a database had been dropped, recreated and I freshly
ran the migrations.</p>

<p>It seems that while Rails 4 supports the HStore datatype, it doesn&#39;t enable the
extension itself. I&#39;ve found two ways too solve this issue in wildly different
ways.</p>

<h2>First Solution: Enable HStore by Default</h2>

<p>This is the common solution that is recommended too solve this issue. It
enables the HStore extension by default on all newly created databases. Too
understand this you need to know a bit about PostgreSQL&#39;s behavior.</p>

<p>When a new database is created, PostgreSQL creates a copy of a special
pre-existing database named &#39;template1&#39; by default. Anything done too this
database will be reflected in all new databases, including enabling extensions.</p>

<p>Too enable the HStore extension on the <code>template1</code> database you can execute the
following command (generally as the postgres user or with your authentication
of choice).</p>
<div class="CodeRay">
  <div class="code"><pre>psql -d template1 -c 'CREATE EXTENSION hstore;'
</pre></div>
</div>

<h2>Second Solution: Rails Migration</h2>

<p>The above solution doesn&#39;t sit well with me. While it&#39;s uncommon for any
individual PostgreSQL server to be shared among different applications with
different databases, the possibility is there. Perhaps the application will get
de-commisioned and the DBA will simply drop the associated database and roles
instead of setting up a new one.</p>

<p>Disconnecting the requirements of the application from the application itself
always seems to lead too trouble.</p>

<p>Rails already has a mechanism too handle modifications too the database
overtime, migrations. They&#39;re solid, well tested, and encapsulate not only how
to get the database to a particular state but also how to return it back to
it&#39;s prior state (generally).</p>

<p>We can also do this without using raw SQL which now also seems a bit... off to
me. The following is a sample Rails migration that will both enable and disable
the extension:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">class</span> <span class="class">ManageHstore</span> &lt; <span class="constant">ActiveRecord</span>::<span class="constant">Migration</span>
  <span class="keyword">def</span> <span class="function">change</span>
    reversible <span class="keyword">do</span> |op|
      op.up { enable_extension <span class="string"><span class="delimiter">'</span><span class="content">hstore</span><span class="delimiter">'</span></span> }
      op.down { disable_extension <span class="string"><span class="delimiter">'</span><span class="content">hstore</span><span class="delimiter">'</span></span> }
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></div>
</div>

<p>Now the biggest problem with this migration is that too use it, you need too
plan ahead of time too use the extension or not worry about freshly running all
the migrations (generally because you dropped and created the database). This
migration needs to be named so it alphabetically comes before any migration in
your application that makes use of the HStore datatype.</p>

<p>ActiveRecord uses timestamps at the beginning of the migration names to handle
this alphabetic sorting, and such you&#39;ll want to fake this in before you used
the HStore datatype.</p>

      </article>
    </div>
  
</div>

    </div>
  </body>
</html>
