<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Rack - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Rack" />
    <meta property="og:url" content="https://stelfox.net/tags/rack/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git io:repos/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <div class="post">
  <h1>Rack</h1>
  
    <div class='post'>
      <h2><a href="/blog/2012/02/updating-to-a-newer-rails-on-dreamhost/">Updating to a Newer Rails on DreamHost</a></h1>
      <aside>Posted at: 2012-02-19 23:13:48 -0500</aside>
      <article>
        <p>I&#39;ve started getting heavily into Ruby on Rails development and wanted to use
it in my DreamHost account. I&#39;ve had a shared web account with them since 2004
and they&#39;ve always treated me well. As a former PHP developer they&#39;ve always
had everything that I&#39;ve needed (minus PostgreSQL but everyone has their flaws
hahah) and I was sure they would have my back with Rails.</p>

<p>Unfortunately I found a very old version of Ruby, an old version of Rails and a
sort of locked down way to install gems. Googling and DreamHost&#39;s wiki resulted
in lots of questions but few real this-is-how-you-do-it answers. I finally
managed to piece together a solid solution to get a newer Rails running on
DreamHost through their Passenger installation. This solution doesn&#39;t fix the
version of Ruby I have to use but it gives me enough control over the actual
Rails environment that I&#39;m willing to look past it.</p>

<p>For those out there, yes I am aware of Heroku and professionally I have sites
on there. Yes I know it&#39;s free for a basic account but as soon as you start
getting into real hosting the web worker dynos, database dynos, log drains all
quickly add up to a monthly price that costs me more than two years of
DreamHost hosting.</p>

<p>Please note that this guide assumes you are starting from a completely fresh
DreamHost user. If you&#39;ve made changes to your shell files, you&#39;ll need to
adapt them for this. I also assume that <em>you have not yet setup the site to be
&quot;hosted&quot;</em>. What I mean by this is the domain shows up in your DreamHost account
under a heading of &quot;Registered domains without hosting&quot;. It isn&#39;t a big deal if
you have already set it up but you&#39;ll probably need pay attention to the last
part to ensure it is setup properly.</p>

<p>So what will this guide get you?</p>

<ul>
<li>A version of Rails that is 8 minor revisions newer (3.0.11 vs 3.0.3). This
includes several security fixes.</li>
<li>An isolated gemset from other applications, preventing nightmare gem
dependency issues when hosting several rails app in the same account</li>
<li>A very well defined environment that will allow you to replicate a live
server environment easily in a development environment</li>
</ul>

<p>SSH into your DreamHost user, open up .bashrc file and add this:</p>
<div class="CodeRay">
  <div class="code"><pre>export PATH=$HOME/.gems/bin:$HOME/opt/bin:$PATH
export GEM_HOME=$HOME/.gems
export GEM_PATH=&quot;$GEM_HOME&quot;
export RUBYLIB=&quot;$HOME/opt/lib:$RUBYLIB&quot;

alias gem=&quot;nice -n19 ~/opt/bin/gem&quot;
</pre></div>
</div>

<p>And .bash_profile:</p>
<div class="CodeRay">
  <div class="code"><pre>source ~/.bashrc
</pre></div>
</div>

<p>Run the following commands to setup the environment for the upcoming steps:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ mkdir ~/{src,opt}
[dreamhost]$ cd src
[dreamhost]$ wget http://production.cf.rubygems.org/rubygems/rubygems-1.3.7.tgz
[dreamhost]$ tar -xzf rubygems-1.3.7.tgz
[dreamhost]$ rm -f rubygems-1.3.7.tgz
[dreamhost]$ cd rubygems-1.3.7/
[dreamhost]$ ruby setup.rb --prefix=$HOME/opt
[dreamhost]$ cd ~/opt/bin/
[dreamhost]$ ln -s gem1.8 gem
</pre></div>
</div>

<p>At this point you&#39;re ready to start using the rubygems version you just
installed.</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ gem -v
1.3.6
[dreamhost]$ source ~/.bash_profile
[dreamhost]$ gem -v
1.3.7
</pre></div>
</div>

<p>You&#39;ll want to update to the latest version locally:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ gem update --system
Updating RubyGems
Updating rubygems-update
Successfully installed rubygems-update-1.8.17
Updating RubyGems to 1.8.17
Installing RubyGems 1.8.17
RubyGems 1.8.17 installed

RubyGems installed the following executables:
        /home/&lt;username&gt;/opt/bin/gem1.8
[dreamhost]$ gem -v
1.8.17
</pre></div>
</div>

<p>Please note that you might have a newer version if one has been released since
I wrote this guide.</p>

<p>Because I don&#39;t need ruby documentation in my server environment I disable the
installation and generation by default by creating a ~/.gemrc file and
populating it like so:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="key">install</span>: <span class="string"><span class="content">--no-rdoc --no-ri</span></span>
<span class="key">update</span>: <span class="string"><span class="content">--no-rdoc --no-ri</span></span>
</pre></div>
</div>

<p>Install bundler and rake locally.</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ gem install bundler
Fetching: bundler-1.0.22.gem (100%)
Successfully installed bundler-1.0.22
1 gem installed
[dreamhost]$ gem install rake
Fetching: rake-0.9.2.2.gem (100%)
Successfully installed rake-0.9.2.2
1 gem installed
</pre></div>
</div>

<p>Installing more gems than this into the local system isn&#39;t recommended. If you
define the gems for individual applications you want inside your project&#39;s
Gemfile you can prevent dependency hell when you&#39;re updating gems.</p>

<p>Instead we can setup RVM to handle gemsets.</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ bash -s stable &lt; &lt;(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer)
</pre></div>
</div>

<p>You&#39;ll need to source your .bash_profile file again and make sure that RVM is
up and working like so:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ source ~/.bash_profile
[dreamhost]$ rvm -v

rvm 1.10.2 by Wayne E. Seguin , Michal Papis  [https://rvm.beginrescueend.com/]
</pre></div>
</div>

<p>Before we can start using project specific gemsets we need to install a
matching ruby version with the DreamHost one. This is where most people will
want to differ from my instructions but I&#39;ll tell you now it won&#39;t work.
DreamHost as of this tutorial was using ruby-1.8.7-p72 you can check this by
running the following:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ ruby -v
ruby 1.8.7 (2008-08-11 patchlevel 72) [x86_64-linux]
</pre></div>
</div>

<p>We need to use this version specifically because this is what DreamHost&#39;s
passenger (aka mod_rails) will be running under. Using another version will
work while testing from your command line, but issues will crop up on your
production site. There isn&#39;t anyway to work around that short of purchasing a
VPS or dedicated server, since you&#39;re reading this I&#39;m going to assume you&#39;ve
already considered that and passed on that option. Of course you&#39;re also
welcome to completely disregard this warning as well.</p>

<p>So lets go ahead and install the appropriate ruby version through RVM:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ rvm install ruby-1.8.7-p72
[dreamhost]$ rvm use --default ruby-1.8.7-p72
[dreamhost]$ ruby -v
ruby 1.8.7 (2008-08-11 patchlevel 72) [x86_64-linux]
[dreamhost]$ which ruby
/home//.rvm/rubies/ruby-1.8.7-p72/bin/ruby
</pre></div>
</div>

<p>And now we&#39;re using our own copy of the same version of ruby and it&#39;s being run
out of our home directory. Excellent. This means we can now create unique
gemsets for our projects without worrying about dependencies between them.</p>

<p>Lets setup a simple project for example.com using rails 3.0.11 just as a
sample. Why not 3.1.x or 3.2.x? Well the catch is another old gem running in
DreamHost&#39;s Passenger. They are running rack version 1.2.1 and as of 3.1.0
rails started requiring rack 1.3.2 or later, with rails 3.2.x it jumped all the
way up to 1.4.5 or later. Of course I found this out the hard way... This could
be worked around by running the application as a FastCGI application and I
intend to put up a guide for that as soon as I can get that environment stable.</p>

<p>We&#39;ll start by creating a the domain folder for it and setting up an .rvmrc
file with a unique gemset for the project.</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ mkdir ~/example.com
[dreamhost]$ cd ~/example.com
[dreamhost]$ rvm --create --rvmrc ruby-1.8.7-p72@example_com
</pre></div>
</div>

<p>Leave the directory and come back in. It should alert you about a &quot;new or
modified&quot; .rvmrc file in the directory. This is the one you just created and
yes you want to trust it. You trust yourself don&#39;t you?</p>

<p>Verify we&#39;re inside our gemset real quick:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ rvm gemset list

gemsets for ruby-1.8.7-p72 (found in /home//.rvm/gems/ruby-1.8.7-p72)
=&gt; example_com
   global
</pre></div>
</div>

<p>Perfect the arrow is next to our gemset. Lets install rails 3.0.11 (DreamHost
currently provides version 3.0.3).</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ gem install rails -v 3.0.11
</pre></div>
</div>

<p>It will take a few moments for ruby gems to go out pull down the package lists,
figure out dependencies, grab to source and install them so get a drink of
water and come back.</p>

<p>Great! You&#39;re back lets make sure we&#39;re running the right version of rails now:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ rails -v
Rails 3.0.11
</pre></div>
</div>

<p>Voila! Lets get that project going with a mysql backend:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ rails new . -d mysql
</pre></div>
</div>

<p>And because it&#39;s good to do lets get this under version control.</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ git init
Initialized empty Git repository in /home/&lt;username&gt;/example.com/.git/
[dreamhost]$ git add .
[dreamhost]$ git commit -m &quot;Initial project commit&quot;
</pre></div>
</div>

<p>Before we go any further there is a gem that needs to be added to our Gemfile.
If you bundled and ran the console right now it would be seem happy but there
is a subtle error that you wouldn&#39;t find out until the very end and it&#39;s better
to get it out of the way now.</p>

<p>Add the following line to the Gemfile anywhere in the main part of the config,
I prefer near the top:</p>
<div class="CodeRay">
  <div class="code"><pre>gem 'rack', '1.2.1'
</pre></div>
</div>

<p>Then we&#39;ll re-bundle to make sure we have it:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ bundle install
</pre></div>
</div>

<p>You can make sure your project is happy by popping open the rails console.</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ rails console
Loading development environment (Rails 3.0.11)
1.8.7 :001 &gt;
</pre></div>
</div>

<p>Woo! That right there is Rails 3.0.11 working on DreamHost. Since it&#39;s working
lets add another commit:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ git commit -a -m &quot;Added rack 1.2.1 and tested for working rails 3.0.11&quot;
</pre></div>
</div>

<p>I&#39;ve already setup a database for this site named &quot;example_com&quot; with user
&quot;examplewebperson&quot; and password &quot;web_persons_password&quot; on &quot;mysql.example.com&quot;.
DreamHost makes this process pretty intuitive through their panel and there are
plenty of other tutorials out there to help you along if you get stuck so I&#39;m
going to skip over that part. I also personally prefer to use sqlite3 for
development and testing as it means I don&#39;t have to run another service on my
development machines. In that light this is what my config/database.yml looks
like:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="key">development</span>:
  <span class="key">adapter</span>: <span class="string"><span class="content">sqlite3</span></span>
  <span class="key">encoding</span>: <span class="string"><span class="content">utf8</span></span>
  <span class="key">database</span>: <span class="string"><span class="content">db/development.sqlite3</span></span>

<span class="key">test</span>:
  <span class="key">adapter</span>: <span class="string"><span class="content">sqlite3</span></span>
  <span class="key">encoding</span>: <span class="string"><span class="content">utf8</span></span>
  <span class="key">database</span>: <span class="string"><span class="content">db/test.sqlite3</span></span>

<span class="key">production</span>:
  <span class="key">adapter</span>: <span class="string"><span class="content">mysql2</span></span>
  <span class="key">encoding</span>: <span class="string"><span class="content">utf8</span></span>
  <span class="key">reconnect</span>: <span class="string"><span class="content">false</span></span>
  <span class="key">database</span>: <span class="string"><span class="content">example_com</span></span>
  <span class="key">pool</span>: <span class="string"><span class="content">5</span></span>
  <span class="key">username</span>: <span class="string"><span class="content">examplewebperson</span></span>
  <span class="key">password</span>: <span class="string"><span class="content">web_persons_password</span></span>
  <span class="key">host</span>: <span class="string"><span class="content">mysql.example.com</span></span>
</pre></div>
</div>

<p>We&#39;ll need to add the sqlite3 gem for the test and development environment, add
this to the end of your Gemfile:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="error">group :development, :test do</span>
  <span class="error">gem 'sqlite3'</span>
<span class="error">end</span>
</pre></div>
</div>

<p>And once again run:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ bundle install
</pre></div>
</div>

<p>Lets make sure our development and then production databases are happy:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ rake db:migrate
[dreamhost]$ sqlite3 db/development.sqlite3
SQLite version 3.5.9
Enter &quot;.help&quot; for instructions
sqlite&gt; .schema
CREATE TABLE &quot;schema_migrations&quot; (&quot;version&quot; varchar(255) NOT NULL);
CREATE UNIQUE INDEX &quot;unique_schema_migrations&quot; ON &quot;schema_migrations&quot; (&quot;version&quot;);
sqlite&gt; .quit
[dreamhost]$ RAILS_ENV=production rake db:migrate
[dreamhost]$ mysql -u examplewebperson -pweb_persons_password -h mysql.example.com example_com

mysql&gt; show tables;
+----------------------------+
| Tables_in_example_com |
+----------------------------+
| schema_migrations          |
+----------------------------+
1 row in set (0.01 sec)
mysql&gt;; quit
</pre></div>
</div>

<p>Lets commit one last time now that we have some schema:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ git add .
[dreamhost]$ git commit -m &quot;Configured database&quot;
</pre></div>
</div>

<p>We&#39;re almost there, open up <u>config/environment.rb</u> and add this line to the
top of this file. Pay close attention after the @ sign on that as it should be
the same as the gemset you created earlier.</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">if</span> <span class="predefined-constant">ENV</span>[<span class="string"><span class="delimiter">&quot;</span><span class="content">RACK_ENV</span><span class="delimiter">&quot;</span></span>] == <span class="string"><span class="delimiter">&quot;</span><span class="content">production</span><span class="delimiter">&quot;</span></span>
  <span class="predefined-constant">ENV</span>[<span class="string"><span class="delimiter">'</span><span class="content">GEM_PATH</span><span class="delimiter">'</span></span>] = <span class="constant">File</span>.expand_path(<span class="string"><span class="delimiter">'</span><span class="content">~/.rvm/gems/ruby-1.8.7-p72@example_com</span><span class="delimiter">'</span></span>) + <span class="string"><span class="delimiter">'</span><span class="content">:/usr/lib/ruby/gems/1.8</span><span class="delimiter">'</span></span>
<span class="keyword">end</span>
</pre></div>
</div>

<p>Last thing, since we&#39;re working around a lot of things we need to run bundle
install in the production environment to make sure we have all the dependencies
we need for the live site. This unfortunately will need to be done everytime
you manipulate your gem sets:</p>
<div class="CodeRay">
  <div class="code"><pre>[dreamhost]$ RAILS_ENV=production bundle install
</pre></div>
</div>

<p>Open up the DreamHost panel and find the domain your setting up under the
&quot;Manage Domains&quot; setting. Add Hosting to it. Make sure you are running it under
the user that we just set everything up in with a web directory set to/public.
For example my testing domain would be example.com/public. Check the checkbox
for &quot;Passenger&quot; and then hit the button &quot;Fully host this domain&quot;.</p>

<p>As soon as you receive an email from the friendly DreamHost robot, load your
site up in a web browser and you should be greeted with the stock Rails 3.0.11
site. Note that the &quot;About your application&#39;s environment&quot; link will not work
in the production environment, this is intentional and expected for Rails.</p>

<p>This is where I leave you to develop your site. Good luck!</p>

      </article>
    </div>
  
</div>

    </div>
  </body>
</html>
