<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Yum - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Yum" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/yum/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Yum</h1>

<p>Package update/installation utility.</p>

<h2>Security Notes</h2>

<p>Changes packages installed on the server... very dangerous.</p>

<h2>Firewall Adjustments</h2>

<p>Needs to be able to connect to Fedora mirrors usually use FTP, HTTP and HTTPS.</p>

<h2>Configuration</h2>
<div class="CodeRay">
  <div class="code"><pre>yum install yum-plugin-fastestmirror yum-plugin-security yum-presto \
  yum-plugin-changelog yum-plugin-protectbase -y
</pre></div>
</div>

<h3>/etc/yum.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>[main]
cachedir=/var/cache/yum/$basearch/$releasever
keepcache=0
debuglevel=2
logfile=/var/log/yum.log
exactarch=1
obsoletes=1
gpgcheck=1
plugins=1
installonly_limit=3
metadata_expire=90m
</pre></div>
</div>

<h3>/etc/yum/pluginconf.d/changelog.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>[main]
enabled=1
when=pre
always=true
</pre></div>
</div>

<h3>/etc/yum/pluginconf.d/fastestmirror.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>[main]
enabled=1
verbose=1
always_print_best_host = true
socket_timeout=3
hostfilepath=timedhosts.txt
maxhostfileage=10
maxthreads=15
exclude=.gov, facebook
include_only=.org,.edu,.com,.net
</pre></div>
</div>

<h3>/etc/yum/pluginconf.d/presto.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>[main]
enabled=1
</pre></div>
</div>

<h3>/etc/yum/pluginconf.d/protectbase.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>[main]
enabled = 1
</pre></div>
</div>

<h3>/etc/yum/pluginconf.d/security.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>[main]
enabled=1
</pre></div>
</div>

<h2>Repo Setup</h2>

<p>Install a webserver and the helper utilities for managing repos.</p>
<div class="CodeRay">
  <div class="code"><pre>yum install createrepo repoview nginx -y
</pre></div>
</div>

<p>Create a diffie-hellman parameter file for the webserver:</p>
<div class="CodeRay">
  <div class="code"><pre>openssl dhparam -rand - 4096 &gt; /etc/pki/tls/certs/dhparam.pem
</pre></div>
</div>

<p>We are also going to generate a super quick self-signed certificate for now
(and we its going to expire in 30 days to force us to replace it).</p>
<div class="CodeRay">
  <div class="code"><pre>echo -e &quot;AC\n\n \n \n\nrepo-01.i.0x378.net\n\n&quot; | openssl req -new -x509 \
  -newkey rsa:4096 -keyout /etc/pki/tls/private/repo.key -nodes -days 30 \
  -out /etc/pki/tls/certs/repo.crt &amp;&gt; /dev/null
</pre></div>
</div>

<p>Create the base directories for the repo:</p>
<div class="CodeRay">
  <div class="code"><pre># Fedora 19 Base Repo
mkdir -p /var/www/repo-01.i.0x378.net/fedora/linux
cd /var/www/repo-01.i.0x378.net/fedora/linux

# Fedora Releases
mkdir -p releases/19/{Fedora,Everything}/{i386/os/Packages,i386/debuginfo/Packages,source/SRPMS,x86_64/os/Packages,x86_64/debuginfo/Packages}
mkdir -p releases/19/Fedora/i386/os/Packages/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
mkdir -p releases/19/Fedora/i386/debuginfo/Packages/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
mkdir -p releases/19/Fedora/x86_64/os/Packages/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
mkdir -p releases/19/Fedora/x86_64/debuginfo/Packages/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
mkdir -p releases/19/Everything/i386/os/Packages/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
mkdir -p releases/19/Everything/i386/debuginfo/Packages/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
mkdir -p releases/19/Everything/x86_64/os/Packages/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
mkdir -p releases/19/Everything/x86_64/debuginfo/Packages/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}
mkdir -p releases/19/Everything/source/SRPMS/{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}

# Fedora Updates
mkdir -p updates/19/{i386,SRPMS,x86_64}

chown -R nginx:nginx /var/www/repo-01.i.0x378.net/
chmod 2775 /var/www/repo-01.i.0x378.net
</pre></div>
</div>

<p>Disable the default server configured on port 80.</p>

<p>Create a server config for the repo:</p>

<p>cat &gt; /etc/nginx/conf.d/repo.conf &lt;&lt;EOF
server {
  listen 443;
  ssl on;</p>

<p># Certs sent to the client in SERVER HELLO are concatenated in ssl_certificate
  ssl_certificate /etc/pki/tls/certs/repo.crt;
  ssl_certificate_key /etc/pki/tls/private/repo.key;</p>

<p># Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 or 4096 bits
  ssl_dhparam /etc/pki/tls/certs/dhparam.pem;</p>

<p>ssl_session_timeout 5m;
  ssl_session_cache shared:NginxCache123:50m;
  ssl_protocols TLSv1.2 TLSv1.1 TLSv1;</p>

<p>ssl_ciphers &#39;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK&#39;;</p>

<p>ssl_prefer_server_ciphers on;</p>

<p># Enable this if your want HSTS (recommended, but be careful)
  add_header Strict-Transport-Security max-age=15768000;</p>

<p># OCSP Stapling, fetch OCSP records from URL in ssl_certificate and cache
  # them
  #ssl_stapling on;
  #ssl_stapling_verify on;</p>

<p># Verify chain of trust of OCSP response using the root CA and any
  # intermediate certs
  #ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;</p>

<p>resolver 192.168.122.1;</p>

<p># <insert the rest of your server configuration here>
  server_name repo-01.i.0x378.net;</p>

<p>location / {
    root      /var/www/repo-01.i.0x378.net;
    autoindex on;
  }
}
EOF</p>

<p>Open up port 443 on the firewall...</p>
<div class="CodeRay">
  <div class="code"><pre>-A INPUT  -m tcp -p tcp --dport 443 -s 192.168.122.0/24 -m conntrack --ctstate NEW -j ACCEPT
</pre></div>
</div>

<p>Enable the webserver to start automatically:</p>
<div class="CodeRay">
  <div class="code"><pre>systemctl enable nginx.service
</pre></div>
</div>

<p>Any standard packaged RPMs should be moved into
<code>/var/www/repo-01.i.0x378.net/fedora/linux/releases/19/Everything/x86_64/os/Packages/</code>.
Specifically the folder that matches the first letter of the package.</p>

<p>Debug RPMs should be moved into
<code>/var/www/repo-01.i.0x378.net/fedora/linux/releases/19/Everything/x86_64/debuginfo</code>.
Specifically the folder that matches the first letter of the package.</p>

<p>Source RPMs should be moved into
<code>/var/www/repo-01.i.0x378.net/fedora/linux/releases/19/Everything/source/SRPMS/</code>.
Specifically the folder that matches the first letter of the package.</p>

<p>Create the source repository:</p>
<div class="CodeRay">
  <div class="code"><pre>cd /var/www/repo-01.i.0x378.net/fedora/linux/releases/19/Everything/source/SRPMS
createrepo .
</pre></div>
</div>

<p>Create the standard repository:</p>
<div class="CodeRay">
  <div class="code"><pre>cd /var/www/repo-01.i.0x378.net/fedora/linux/releases/19/Everything/x86_64/os
createrepo .
</pre></div>
</div>

<p>Create the debug repository:</p>
<div class="CodeRay">
  <div class="code"><pre>cd /var/www/repo-01.i.0x378.net/fedora/linux/releases/19/Everything/x86_64/debuginfo
createrepo .
</pre></div>
</div>

<p>You will also need to distribute a repository file that points at the server:</p>
<div class="CodeRay">
  <div class="code"><pre>[0x378]
name=0x378 Private Repo $releasever - $basearch
failovermethod=priority
baseurl=https://repo-01.i.0x378.net/fedora/linux/releases/$releasever/Everything/$basearch/os/
enabled=1
priority=10
metadata_expire=7d
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-0x378-$releasever-$basearch

[0x378-updates]
name=0x378 Private Repo $releasever - $basearch - Updates
failovermethod=priority
baseurl=https://repo-01.i.0x378.net/fedora/linux/updates/$releasever/$basearch/
enabled=1
priority=10
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch

[0x378-updates-debuginfo]
name=0x378 Private Repo $releasever - $basearch - Updates - Debug
failovermethod=priority
baseurl=https://repo-01.i.0x378.net/fedora/linux/updates/$releasever/$basearch/debug/
enabled=0
priority=10
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch

[0x378-updates-source]
name=0x378 Private Repo $releasever - Updates Source
failovermethod=priority
baseurl=https://repo-01.i.0x378.net/fedora/linux/updates/$releasever/SRPMS/
enabled=0
priority=10
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch

[0x378-debuginfo]
name=0x378 Private Repo $releasever - $basearch - Debug
failovermethod=priority
baseurl=https://repo-01.i.0x378.net/fedora/linux/releases/$releasever/Everything/$basearch/debug/
enabled=0
priority=10
metadata_expire=7d
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-0x378-$releasever-$basearch

[0x378-source]
name=0x378 Private Repo $releasever - Source
failovermethod=priority
baseurl=https://repo-01.i.0x378.net/fedora/linux/releases/$releasever/Everything/source/SRPMS/
enabled=0
priority=10
metadata_expire=7d
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-0x378-$releasever-$basearch
</pre></div>
</div>

<p>Along with that repository you should install <code>yum-plugin-priorities</code> to make
sure any rebuilt plugins are pulled out of the custom repo instead of the
standard ones.</p>

    </div>
  </body>
</html>
