<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Qpid - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Qpid" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/qpid/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git io:repos/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Qpid</h1>

<p>Qpid is an open source AMQP broker, providing transaction management, queuing,
distribution, security, management, clustering, and federation.</p>

<ul>
<li><a href="http://wiki.openstack.org/QpidSupport">http://wiki.openstack.org/QpidSupport</a></li>
<li><a href="http://www.linuxjournal.com/magazine/advanced-message-queuing-protocol-amqp?page=0,1">http://www.linuxjournal.com/magazine/advanced-message-queuing-protocol-amqp?page=0,1</a></li>
</ul>

<h2>Installation</h2>

<p>Fedora provides a package for qpid called <code>qpid-cpp-server</code> which can be
installed like so:</p>
<div class="CodeRay">
  <div class="code"><pre>yum install qpid-cpp-server qpid-cpp-server-ssl qpid-cpp-server-store \
  qpid-cpp-server-ha -y
</pre></div>
</div>

<p>Additional packages that may be of use:</p>

<ul>
<li>qpid-tools</li>
<li>qpid-qmf</li>
</ul>

<h2>Configuration</h2>

<p>The following configuration file assumes the rest of the configuration on this
page. You&#39;ll want to replace the existing configuration at <code>/etc/qpidd.conf</code>
with the following:</p>
<div class="CodeRay">
  <div class="code"><pre>##### General Configuration #####

# Directory to contain persistent data
data-dir=/var/lib/qpidd/

worker-threads=3

##### Queue Configuration #####

# Set queue events async, used for services like replication
async-queue-events=no

# How often to attempt purging expired messages from the queues
queue-purge-interval=600

# Default storage limit of any given queue
default-queue-limit=104857600

# The ratio of any specified queue limit at which an event will be raised
default-event-threshold-ratio=80

# Percent of queues maximum capacity at which flow control is activated and
# deactivated.
default-flow-stop-threshold=80
default-flow-resume-threshold=70

# Group identifier to assign to messages delivered to a message group queue that
# do not contain an identifier.
default-message-group=qpid.no-group

# Add current time to each received message
enable-timestamp=yes

##### Management Options #####

# Enable management, publishing data every 10 seconds, with QMF protocol 1 and
# 2
mgmt-enable=yes
mgmt-publish=yes
mgmt-pub-interval=10
mgmt-qmf1=yes
mgmt-qmf2=yes

##### Networking Configuration #####

connection-backlog=10

link-heartbeat-interval=120
link-maintenace-interval=2

# Maximum time a connection can take to send the initial protocol negotiation
# (in milliseconds).
max-negotiate-time=2000

# Port to listen on for unencrypted connections
port=5672

# Set TCP_NODELAY on TCP connections
tcp-nodelay=yes

##### Logging Options #####

log-enable=info+

log-category=yes
log-level=yes
log-time=no

log-to-stderr=no
log-to-stdout=no
log-to-syslog=yes

##### Persistent Storage Options #####

# Number of pages in each journal (1 page is 64Kb)
jfile-size-pgs=24

# Default number of files for each journal instance (queue)
num-jfiles=8

truncate=no

# Size of the pages in the write page cache in Kb, allowable values are powers
# of 2
wcache-page-size=32

##### Authentication &amp; Authorization Configurations #####

# Enable authentication, and configured to use the QPID realm
auth=yes
realm=QPID

# Get SASL configuration from standard redhat location
sasl-config=/etc/sasl2/

# The policy file to load from, loaded from the data dir
acl-file=qpid.acl

# Maximum combined number of connections allowed (0 is no limit)
max-connections=500
max-connections-per-user=0
max-connections-per-ip=0

##### SSL Settings #####

ssl-port=5671

# File containing password to use for accessing the certificate database
ssl-cert-password-file=/var/lib/qpidd/ssl-db-pass

# Where the cert database is stored, the data directory is as good as any
ssl-cert-db=/var/lib/qpidd

# Name of the cerificate to use (usually the hostname)
ssl-cert-name=agni

# Whether or not the server will accept unencrypted connections, there is of
# course overhead to encrypted connections and if the only services that will
# be talking to it will be the localhost then there is no need to require it...
# External connections should of course be encrypted wherever possible.
require-encryption=no
</pre></div>
</div>

<p>You&#39;ll want to enable and start the service once the configuration is complete.</p>
<div class="CodeRay">
  <div class="code"><pre>systemctl enable qpidd.service
systemctl start qpidd.service
</pre></div>
</div>

<h3>Enabling User/Pass Authentication</h3>

<p>By default only ANONYMOUS authentication is enabled which isn&#39;t good for any
production systems... Qpid uses SASL for user authentication and that is how we
need to configure what system to make use of. Open up the file
<code>/etc/sasl2/qpidd.conf</code> and replace it&#39;s contents with the following:</p>
<div class="CodeRay">
  <div class="code"><pre>auxprop_plugin: sasldb
mech_list: DIGEST-MD5 PLAIN+SSL
pwcheck_method: auxprop
sasldb_path: /var/lib/qpidd/qpidd.sasldb
sql_select: dummy select
</pre></div>
</div>

<h3>Creating Users</h3>

<p>I&#39;ve named the SASL authentication realm after the service that uses it, in
this case Qpid (makes sense no?). You&#39;ll need to create at least one user to
make use of authentication, I chose to make one user for administration tasks
(admin), and one per server named after the server (in this case the server is
named openstack after the service I mainly use Qpid for).</p>

<p>Create the user&#39;s as root:</p>
<div class="CodeRay">
  <div class="code"><pre>saslpasswd2 -f /var/lib/qpidd/qpidd.sasldb -u QPID admin
saslpasswd2 -f /var/lib/qpidd/qpidd.sasldb -u QPID openstack
</pre></div>
</div>

<p>Set STRONG passwords for both as arbitrary instructions can be provided to
various openstack services through this service.</p>

<p>The saslpasswd2 command will additionally create the password file, but with
incorrect permissions. Set the ownership and strengthen the permissions like
so:</p>
<div class="CodeRay">
  <div class="code"><pre>chown qpidd:qpidd /var/lib/qpidd/qpidd.sasldb
chmod 0640 /var/lib/qpidd/qpidd.sasldb
</pre></div>
</div>

<p>If you have started Qpid with <code>auth=yes</code> configured before creating the account
it will automatically create this file and add a user with the username and
password &#39;guest&#39;.</p>

<h3>Listing Users</h3>

<p>You can list all the configured realm / username combinations with the
following command:</p>
<div class="CodeRay">
  <div class="code"><pre>sasldblistusers2 -f /var/lib/qpidd/qpidd.sasldb
</pre></div>
</div>

<h3>User ACLs</h3>

<p>The ACL files are pretty straight-forward and plain text. The file lives at
<code>/var/lib/qpidd/qpid.acl</code> which doesn&#39;t exist initially and will need to be
created. This is a solid initial ACL allowing the admin and openstack access to
any permissions they need while preventing anything else.</p>

<p>In the future I&#39;ll need to make this more fine-grained. This is more useful
when using Kerberos as the back end which would have more users you wouldn&#39;t
want to have access.</p>
<div class="CodeRay">
  <div class="code"><pre># Define the admins and let them do whatever they want
group admins admin@Qpid
acl allow admins all all

# Define the server accounts and set their permissions
group servers openstack@Qpid
acl allow servers all all

# Default deny with logging on any other attempts
acl deny-log all all
</pre></div>
</div>

<p>Ensure the ownership and permissions on the file are appropriate:</p>
<div class="CodeRay">
  <div class="code"><pre>chown qpidd:qpidd /var/lib/qpidd/qpid.acl
chmod 0640 /var/lib/qpidd/qpid.acl
</pre></div>
</div>

<h4>ACL BML Syntax</h4>

<p>ACLs are case-insensitve, all white space is essentially ignored except when
delimiting between syntax types. Lines can be wrapped by ending the line with a
backslash.</p>
<div class="CodeRay">
  <div class="code"><pre>user = username[/domain[@realm]]
user-list = user1 user2 user3 ...
group-name-list = group1 group2 group3 ...

group &lt;group-name&gt; = [user-list] [group-name-list]

permission = [allow|allow-log|deny|deny-log]
action = [consume|publish|create|access|bind|unbind|delete|purge|update]
object = [virtualhost|queue|exchange|broker|link|route|method]
property = [name|durable|owner|routingkey|autodelete|exclusive|
            type|alternate|queuename|schemapackage|schemaclass|
            queuemaxsizelowerlimit|queuemaxsizeupperlimit|
            queuemaxcountlowerlimit|queuemaxcountupperlimit]

acl permission {&lt;group-name&gt;|&lt;user-name&gt;|&quot;all&quot;} {action|&quot;all&quot;} [object|&quot;all&quot; 
            [property=&lt;property-value&gt; ...]]
</pre></div>
</div>

<h4>Action Listing</h4>

<table><thead>
<tr>
<th>Action</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>consume</td>
<td>Applied when subscriptions are created</td>
</tr>
<tr>
<td>publish</td>
<td>Applied on a per message basis on publish message transfers, this rule consumes the most resources</td>
</tr>
<tr>
<td>create</td>
<td>Applied when an object is created, such as bindings, queues, exchanges, links</td>
</tr>
<tr>
<td>access</td>
<td>Applied when an object is read or accessed</td>
</tr>
<tr>
<td>bind</td>
<td>Applied when objects are bound together</td>
</tr>
<tr>
<td>unbind</td>
<td>Applied when objects are unbound</td>
</tr>
<tr>
<td>delete</td>
<td>Applied when objects are deleted</td>
</tr>
<tr>
<td>purge</td>
<td>Similar to delete but the action is performed on more than one object</td>
</tr>
<tr>
<td>update</td>
<td>Applied when an object is updated</td>
</tr>
</tbody></table>

<h4>Object Listing</h4>

<table><thead>
<tr>
<th>Object</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queue</td>
<td>A queue</td>
</tr>
<tr>
<td>exchange</td>
<td>An exchange</td>
</tr>
<tr>
<td>broker</td>
<td>The broker</td>
</tr>
<tr>
<td>link</td>
<td>A federation or inter-broker link</td>
</tr>
<tr>
<td>method</td>
<td>Management or agent or broker method</td>
</tr>
</tbody></table>

<h4>Property Listing</h4>

<table><thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
<th>Usage</th>
</tr>
</thead><tbody>
<tr>
<td>name</td>
<td>String</td>
<td>Object name, such as a queue name or exchange name.</td>
<td></td>
</tr>
<tr>
<td>durable</td>
<td>Boolean</td>
<td>Indicates the object is durable</td>
<td>CREATE QUEUE, CREATE EXCHANGE</td>
</tr>
<tr>
<td>routingkey</td>
<td>String</td>
<td>Specifies routing key</td>
<td>BIND EXCHANGE, UNBIND EXCHANGE, ACCESS EXCHANGE</td>
</tr>
<tr>
<td>autodelete</td>
<td>Boolean</td>
<td>Indicates whether or not the object gets deleted when the connection is closed</td>
<td>CREATE QUEUE</td>
</tr>
<tr>
<td>exclusive</td>
<td>Boolean</td>
<td>Indicates the presence of an exclusive flag</td>
<td>CREATE QUEUE</td>
</tr>
<tr>
<td>type</td>
<td>String</td>
<td>Type of exchange, such as topic, fanout, or xml</td>
<td>CREATE EXCHANGE</td>
</tr>
<tr>
<td>alternate</td>
<td>String</td>
<td>Name of the alternate exchange</td>
<td>CREATE EXCHANGE, CREATE QUEUE</td>
</tr>
<tr>
<td>queuename</td>
<td>String</td>
<td>Name of the queue</td>
<td>ACCESS EXCHANGE</td>
</tr>
<tr>
<td>schemapackage</td>
<td>String</td>
<td>QMF schema package name</td>
<td>ACCESS METHOD</td>
</tr>
<tr>
<td>schemaclass</td>
<td>String</td>
<td>QMF schema class name</td>
<td>ACCESS METHOD</td>
</tr>
<tr>
<td>queuemaxsizelowerlimit</td>
<td>Integer</td>
<td>Minimum value for queue.max_size</td>
<td>CREATE QUEUE</td>
</tr>
<tr>
<td>queuemaxsizeupperlimit</td>
<td>Integer</td>
<td>Maximum value for queue.max_size</td>
<td>CREATE QUEUE</td>
</tr>
<tr>
<td>queuemaxcountlowerlimit</td>
<td>Integer</td>
<td>Minimum value for queue.max_count</td>
<td>CREATE QUEUE</td>
</tr>
<tr>
<td>queuemaxcountupperlimit</td>
<td>Integer</td>
<td>Maximum value for queue.max_count</td>
<td>CREATE QUEUE</td>
</tr>
</tbody></table>

<h3>SSL</h3>

<p>Unfortunately SSL for Qpid isn&#39;t as easy as generating PEM certificates and
pointing the config at them. Qpid makes use of a Mozilla Network Security
Services database. These databases can be created using certutil.</p>

<p>First we&#39;ll need to initialize the database:</p>
<div class="CodeRay">
  <div class="code"><pre>certutil -N -d /var/lib/qpidd/
</pre></div>
</div>

<p>Provide a strong password to the database and put a copy in the file
<code>/var/lib/qpidd/ssl-db-pass</code> on it&#39;s own with no newline.</p>

<p>I already have PKI in place and a trusted <a href="../certificate_authority/">Certificate Authority</a>, so I
just have to import my trusted certificate authority chain. Generate a
certificate for this server and import it&#39;s certificate and chain.</p>

<p>Import the CA cert:</p>
<div class="CodeRay">
  <div class="code"><pre>certutil -A -n cert-authority -t &quot;TC,,&quot; -i ca.crt -d /var/lib/qpidd
</pre></div>
</div>

<p>The server certificate is a bit trickier, before we can import an OpenSSL
generated PEM format key set we&#39;ll need to convert it to a pkcs12 file, luckily
OpenSSL plays well with others:</p>
<div class="CodeRay">
  <div class="code"><pre>openssl pkcs12 -export -out qpid.pfx -inkey qpid.key -in qpid.crt -certfile ca.crt
</pre></div>
</div>

<p>Import the newly generate pkcs12 file, it will firstly ask for the password for
the database, and then the password for the pkcs12 file:</p>
<div class="CodeRay">
  <div class="code"><pre>pk12util -d /var/lib/qpidd/ -i qpid.pfx
</pre></div>
</div>

<p>And be sure to clean up after yourself:</p>
<div class="CodeRay">
  <div class="code"><pre>rm qpid.pfx
</pre></div>
</div>

<p>Set the permissions on all of the files we just created:</p>
<div class="CodeRay">
  <div class="code"><pre>chown qpidd:qpidd /var/lib/qpidd/{cert8.db,key3.db,ssl-db-pass}
chmod 0640 /var/lib/qpidd/{cert8.db,key3.db,ssl-db-pass}
</pre></div>
</div>

<h3>Firewall</h3>
<div class="CodeRay">
  <div class="code"><pre># Encrypted Qpid connections (Unencrypted are 5672 but those shouldn't be
# accessed remotely)
-A SERVICE -m tcp -p tcp --dport 5671 -j ACCEPT
</pre></div>
</div>

    </div>
  </body>
</html>
