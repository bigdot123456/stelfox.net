<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Asterisk - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Asterisk" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/asterisk/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git https://io.stelfox.net/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Asterisk</h1>

<p>Asterisk is a software implementation of a telephone private branch exchange
(PBX) originally created in 1999 by Mark Spencer of Digium. Like any PBX, it
allows attached telephones to make calls to one another, and to connect to
other telephone services including the public switched telephone network (PSTN)
and Voice over Internet Protocol (VoIP) services. Its name comes from the
asterisk symbol, “*”.</p>

<p>NOTE: FreeSWITCH would be a much more solid replacement for asterisk and has
support for interops with Linksys SPA3000 as well as ZRTP and SRTP support. It
might be wise to look into using kamailio as a front end SIP router though this
doesn&#39;t seem to be necessary unless we want to start handling multi-thousands
of calls concurrently.</p>

<p>A <a href="../../devices/sipura_spa3000/">few</a> <a href="../festival/">references</a> for help when building FreeSWITCH.</p>

<h2>Previous Reasoning</h2>

<p>This was setup on my private network to provide a land line phone to my office
using our existing internet connection. I wanted to go about doing this without
having to pay for the services as I don&#39;t expect this to get a lot of use.</p>

<p>This Asterisk setup involves the use of <a href="http://google.com/voice">Google Voice</a> and <a href="http://www.sipgate.com/">SIPGate</a>.
SIPGate provides a single phone number, SIP connectivity and call forwarding.
Google Voice doesn&#39;t provide services to receive phone calls, however, it can
be setup as an intermediary that will call you and then connect to another
number on your behalf, while also providing call forwarding.</p>

<p>Combining the three will get free incoming and outgoing to anywhere in the US
and Canada. Incoming calls will come from Google Voice, which will forward the
call to the SIPGate phone number, which the Asterisk PBX will be tied to and
we&#39;ll in turn be able to receive the call.</p>

<p>Outgoing calls are a bit more tricky. Implemented using <a href="http://code.google.com/p/pygooglevoice/">pygooglevoice</a>, the
Asterisk box will actually connect to Google Voice&#39;s APIs to dial the number
and call back (making it an incoming call and thus free) to make the outgoing
call.</p>

<h2>Links</h2>

<ul>
<li><a href="http://ofps.oreilly.com/titles/9780596517342/asterisk-Arch.html">http://ofps.oreilly.com/titles/9780596517342/asterisk-Arch.html</a></li>
<li><a href="http://www.asteriskdocs.org/">http://www.asteriskdocs.org/</a></li>
<li><a href="http://www.voip-info.org/">http://www.voip-info.org/</a></li>
<li><a href="http://nerdvittles.com/index.php?p=65">http://nerdvittles.com/index.php?p=65</a></li>
<li><a href="http://www.voip-info.org/wiki/index.php?page=Asterisk+LDAP">http://www.voip-info.org/wiki/index.php?page=Asterisk+LDAP</a></li>
<li><a href="http://download.ag-projects.com/">http://download.ag-projects.com/</a></li>
</ul>

<h2>Security Notes</h2>

<p>Asterisk/SIP are going to be a significant security hole in the network if I
allow outside access to the SIP services (In case I want to say be able to pick
up the phone from my laptop while at a cafe or from my office). I intend to
research making this considerably more secure before allowing this kind of
setup and will document it here.</p>

<p>One of the things for me to note ahead of time is to not put incoming calls
into the same context as my dial plans. This alone will be a significant
increase in any kind of security.</p>

<p>A more thorough discussion of voip security can be found <a href="../../security/voip/">elsewhere</a>.</p>

<h3>Encryption</h3>

<p>The configurations provided have TLS enabled BUT it won&#39;t do any good until the
server has a certificate. A normal webserver certificate in PKCS12 format. FOR
TESTING ONLY you can generate a self signed certificate. You&#39;ll need both the
certificate authority&#39;s cert and the key/cert pair for the server.</p>

<p>You can use the following to create a self-signed one:</p>
<div class="CodeRay">
  <div class="code"><pre>[root@localhost ~]# openssl genrsa -out ca.key 4096
[root@localhost ~]# openssl req -new -x509 -days 3650 -key ca.key -out ca.crt
[root@localhost ~]# openssl genrsa -des3 -out pbx.key 4096
[root@localhost ~]# openssl req -new -key argus.key -out pbx.csr
[root@localhost ~]# openssl x509 -req -days 3650 -in pbx.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out pbx.crt
[root@localhost ~]# openssl rsa -in pbx.key -out pbx.key.insecure
[root@localhost ~]# cat pbx.crt &gt; pbx.pem
[root@localhost ~]# cat pbx.key.insecure &gt;&gt; pbx.pem
[root@localhost ~]# mv pbx.pem ca.crt /var/lib/asterisk/
[root@localhost ~]# restorecon -R /var/lib/asterisk/
[root@localhost ~]# chown asterisk:asterisk /var/lib/asterisk
</pre></div>
</div>

<h3>Firewall Adjustments</h3>
<div class="CodeRay">
  <div class="code"><pre># Allow incoming SIP calls from the local network
-A PRIMARYSERVICES -s 10.13.37.0/24 -m udp -p udp --dport 5060 -j ACCEPT
-A PRIMARYSERVICES -s 10.13.37.0/24 -m tcp -p tcp --dport 5060:5061 -j ACCEPT

# Log and allow SIP traffic from other people
-A PRIMARYSERVICES -m state --state NEW -m udp -p udp --dport 5060 -j LOG --log-prefix &quot;SIP Traffic &quot;
-A PRIMARYSERVICES -m state --state NEW -m tcp -p tcp --dport 5060:5061 -j LOG --log-prefix &quot;SIP Traffic &quot;
-A PRIMARYSERVICES -m udp -p udp --dport 5060 -j ACCEPT
-A PRIMARYSERVICES -m tcp -p tcp --dport 5060:5061 -j ACCEPT

# Allow incoming RTP traffic from the local network
-A PRIMARYSERVICES -s 10.13.37.0/24 -m udp -p udp --dport 10000:10100 -j ACCEPT

# Log and allow RTP traffic from other people
-A PRIMARYSERVICES -m state --state NEW -m udp -p udp --dport 10000:10100 -j LOG --log-prefix &quot;RTP Traffic &quot;
-A PRIMARYSERVICES -m udp -p udp --dport 10000:10100 -j ACCEPT
</pre></div>
</div>

<h3>Fail2Ban</h3>

<p>Due to the overwhelmingly large number of attackers trying to exploit unsecured
Asterisk boxes, configuring <a href="../fail2ban/">Fail2Ban</a> with Asterisk is HIGHLY recommended.
I&#39;m updating the regular expressions in that template as I see attacks, and in
some cases where I intentionally generate the logs myself.</p>

<h2>Config Files</h2>

<p>There are a significant number of configuration files created when asterisk is
installed, these all reside in <code>/etc/asterisk</code>. I&#39;ll go over the ones that I
made modifications too including full source (without the comments that come
included, there are a lot of them). I copied the original files to *.conf.o and
blew away most of the files I edited (including the stock comments). </p>

<h3>/etc/asterisk/asterisk.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- Asterisk's Primary Configuration ---
; Gentlemen

[directories](!)
  astetcdir =&gt; /etc/asterisk                ; The Asterisk configuration files
  astmoddir =&gt; /usr/lib64/asterisk/modules  ; The loadable modules
  astvarlibdir =&gt; /usr/share/asterisk       ; The base location for variable state information used by
                                            ; various parts of Asterisk. This includes items that are
                                            ; written out by Asterisk at runtime
  astdbdir =&gt; /var/spool/asterisk           ; Asterisk will store its internal database in this directory
                                            ; as a file called astdb
  astkeydir =&gt; /var/lib/asterisk            ; Asterisk will use a subdirectory called keys in this
                                            ; directory as the default location for loading keys for
                                            ; encryption
  astdatadir =&gt; /usr/share/asterisk         ; This is the base directory for system-provided data, such as
                                            ; the sound files that come with Asterisk
  astagidir =&gt; /usr/share/asterisk/agi-bin  ; Asterisk will use a subdirectory called agi-bin in this
                                            ; directory as the default location for loading AGI scripts
  astspooldir =&gt; /var/spool/asterisk        ; The Asterisk spool directory, where voicemail, call
                                            ; recordings, and the call origination spool are stored.
  astrundir =&gt; /var/run/asterisk            ; The location where Asterisk will write out it's unix control
                                            ; socket as well as it PID file
  astlogdir =&gt; /var/log/asterisk            ; The asterisk log directory

[options]
  verbose = 3                     ; Sets the default verbose setting for the Asterisk logger
  timestamp = yes                 ; Adds timestamps to all output except output from a CLI command
  initcrypto = yes                ; Load keys from the astkeydir at startup
  systemname = jeeves             ; The name of the PBX, yeah ours is called Jeeves, what you going to do about
                                  ; it?
  maxload = 0.8                   ; Sets a maximum load average. If the load average is at or above this
                                  ; threshold, Asterisk will not accept new calls.
  minmemfree = 10                 ; Sets the minimum number of megabytes of free memory required for Asterisk to
                                  ; continue accepting calls.
  cache_record_files = yes        ; When doing recording, stores the file in record_cache_dir until recording is
                                  ; complete.
  runuser = asterisk              ; Run Asterisk under the user specified
  rungroup = asterisk             ; Run Asterisk under the group specified
  defaultlanguage = en            ; Set the default language
  documentation_language = en_US  ; Set the preferred language for the command help

[files]
  astctlpermissions = 0660  ; Sets the permissions for the Asterisk control socket
  astctlowner = root        ; Sets the owner for the Asterisk control socket
  astctlgroup = asterisk    ; Sets the group for the Asterisk control socket
  astctl = asterisk.ctl     ; Sets the filename for the Asterisk control socket
</pre></div>
</div>

<h3>/etc/asterisk/ccss.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- Call Completion Supplementary Services ---
; Gentlemen

[general]
  cc_max_requests = 20  ; Global limit on the number of CC requests that may be in the Asterisk
                        ; system at any one time.
</pre></div>
</div>

<h3>/etc/asterisk/cdr_adaptive_odbc.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- ODBC Database CDR storage ---
; Gentlemen

[default]
  connection = gentlemen  ; Name of the connections (references res_odbc.conf)
  table = asterisk        ; Name of the table in the database
  usegmtime = yes         ; Use Greenwich Mean Time in the database
</pre></div>
</div>

<h3>/etc/asterisk/cdr.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- Asterisk Call Detail Record Engine Configuration ---
; Gentlemen

[general]
  batch = yes
  enable = yes
  safeshutdown = yes
  scheduleronly = no
  size = 100
  time = 300
  unanswered = yes

[csv]
  accountlogs = yes   ; Create separate log file for each account code
  loguniqueid = yes   ; Log uniqueid for the call
  loguserfield = yes  ; Log user field
  usegmtime = yes     ; Log date and time in GMT
</pre></div>
</div>

<h3>/etc/asterisk/cdr_syslog.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- Asterisk Call Detail Records (CDR) - Syslog Backend ---
; Gentlemen

; This line needs to be added to /etc/rsyslog.conf:
; local4.info                   /var/log/asterisk-cdr.log

[cdr]
  facility=local4
  priority=info

  ; High Resolution Time for billsec and duration fields
  template = '${CDR(clid)}','${CDR(src)}','${CDR(dst)}','${CDR(dcontext)}','${CDR(channel)}','${CDR(dstchannel)}','${CDR(lastapp)}','${CDR(lastdata)}','${CDR(start)}','${CDR(answer)}','${CDR(end)}','${CDR(duration,f)}','${CDR(billsec,f)}','${CDR(disposition)}','${CDR(amaflags)}','${CDR(accountcode)}','${CDR(uniqueid)}','${CDR(userfield)}'
</pre></div>
</div>

<h3>/etc/asterisk/extensions.conf</h3>

<p>The only thing that I have changed in the below configuration is that where it
says &#39;SPA3000&#39; in the variables I used the MAC address of the actual SPA3000
device as it is defined in sip.conf (this has also been changed there). This
will allow it too remain unique even if another is added.</p>
<div class="CodeRay">
  <div class="code"><pre>; --- Asterisk Extension Configuration ---
; Gentlemen

; Global variables to be used in the rest of the dial plan
[globals]
  ; Area information
  LOCALAREACODE=802

  ; User extensions
  U1=SIP/user1
  U2=SIP/user2
  U3=SIP/user3

  ; Device extensions
  PSTNOUT=SIP/SPA3000_PSTNOUT
  PSTNIN=SIP/SPA3000_PSTNIN
  LANDLINE=SIP/SPA3000_LINE

; This context contains the menu for callers coming in over the PSTN line
[pstnmenu]
  exten =&gt; s,1,Verbose(3,${CALLERID(all)})  ; Print the Caller ID to the console if it's available
           same =&gt; n,GoTo(debug,echo,1)
           same =&gt; n,Answer()
           same =&gt; n,HangUp()

  exten =&gt; i,1,GoTo(s,1)

; This context is where unauthenticated SIP clients from the internet are going
; to end up This will provide a certain measure of spam and robot protection by
; requiring the user to answer a simple math question generated on the fly
[unauthenticated]
  ; If we allow numeric extension calls from the internet:
  ;       exten =&gt; _XXX,1,GoTo(internal-public,1,${EXTEN})

  ; If we allow alpha extension calls from the internet (assumes all extensions are lower case)
  ;       exten =&gt; _X.,1,Set(SAFE_EXTEN=${FILTER(a-z,${EXTEN})})
  ;               same =&gt; n,GoTo(internal-public,1,${SAFE_EXTEN})

  ; Catch any unknown or unallowed extensions and give them a &quot;Network out of order&quot; response
  ; This might trip up some brute force tools, and is better than not passing a reason
  exten =&gt; i,1,HangUp(38)

; Our trunk lines should never be making calls into the system, by putting them into this context
; if anyone manages to collect a valid username/password set from one of our trunk they will not be
; able to make calls through our system. This trunk should never have any dialplan in it beyonds 'hang up'
[from-trunk]
  ; Catch any unknown or unallowed extensions and give them a &quot;Network out of order&quot; response
  ; This might trip up some brute force tools, and is better than not passing a reason
  exten =&gt; i,1,HangUp(38)

; This is by far the most dangerous context. This one makes outgoing calls from
[callout]
  exten =&gt; _NXXNXXXXXX,1,Dial(${PSTNOUT}/1${EXTEN})     ; 10-digit pattern match for NANP
  exten =&gt; _9NXXNXXXXXX,1,Dial(${PSTNOUT}/1${EXTEN:1})  ; 10-digit pattern match for NANP (9 first)

  exten =&gt; _NXXXXXX,1,Dial(${PSTNOUT}/${LOCALAREACODE}${EXTEN})     ; 7-digit pattern match for NANP
  exten =&gt; _9NXXXXXX,1,Dial(${PSTNOUT}/${LOCALAREACODE}${EXTEN:1})  ; 7-digit pattern match for NANP
                                                                    ; (9 first)

  ;exten =&gt; _1NXXNXXXXXX,1,Dial(${PSTNOUT}/${EXTEN})     ; Long-distance pattern match for NANP
  ;exten =&gt; _91NXXNXXXXXX,1,Dial(${PSTNOUT}/${EXTEN:1})  ; Long-distance pattern match for NANP (9 first)

  ;exten =&gt; _011.,1,HangUp(63)   ; Deny the International pattern match for calls made from NANP
                                 ; with 'Service or option unavailable'
  ;exten =&gt; _9011.,1,HangUp(63)  ; Deny the International pattern match for calls made from NANP
                                 ; with 'Service or option unavailable' (9 first)

  ; The number they're reaching doesn't match anything we know about, deny it
  exten =&gt; i,1,HangUp()

[internal]
  include =&gt; callout          ; Allow internal phones to call out
  include =&gt; internal-public  ; Include public extensions (user extensions should only be defined once,
                              ; either here or there)

  exten =&gt; 600,1,GoTo(debug,echo,1)

; This context holds the private internal extensions that will be available publicly either
; through a PSTN line or through anonymous SIP connections from the internet. These lines
; will be directly dialable from the internal context
[internal-public]
  exten =&gt; 301,1,Dial(${U1})
  exten =&gt; user1,1,Dial(${U1})

  exten =&gt; 302,1,Dial(${U2})
  exten =&gt; user2,1,Dial(${U2})

  exten =&gt; 303,1,Dial(${U3})
  exten =&gt; user3,1,Dial(${U3})

  exten =&gt; 304,1,Dial(${LANDLINE})
  exten =&gt; landline,1,Dial(${LANDLINE})

; Various extensions that can be used to debug troublesome clients
[debug]
  ; This channel will echo back whatever sounds this server receives from the client
  ; including DTMF tones until they hangup or they press #
  exten =&gt; echo,1,Answer()
    same =&gt; n,Playback(silence/1)   ; Prevent the beginning of our audio from getting cut off
    same =&gt; n,Playback(demo-echotest)
    same =&gt; n,Echo()
    same =&gt; n,Playback(demo-echodone)
    same =&gt; n,Playback(vm-goodbye)
    same =&gt; n,Playback(silence/1)   ; Prevent the end of our audio from getting cut off
    same =&gt; n,HangUp()

  ; This can be used anywhere in any other dialplan through the GoSub() routine like so:
  ;       exten =&gt; example,1,GoSub(debug,log,1(1,[${CHANNEL}] This is the message))
  ; By default all logging is off, to turn it on you need to execute the following commands
  ; at the asterisk console:
  ;       *CLI&gt; core set verbose 0
  ;       *CLI&gt; database put Log all 1
  ;
  ; You can optionally only turn on logging for a single channel by running the following
  ; command in place of the latter command (this example is for the &quot;incoming&quot; channel)
  ;       *CLI&gt; database put Log/channel/incoming 1
  ;
  exten =&gt; log,1,GotoIf($[${DB_EXISTS(Log/all)} = 0]?checkchan1)
    same =&gt; n,GotoIf($[${ARG1} &lt;= ${DB(Log/all)}]?log)
    same =&gt; n(checkchan1),Set(KEY=Log/channel/${CHANNEL})
    same =&gt; n,GotoIf($[${DB_EXISTS(${KEY})} = 0]?checkchan2)
    same =&gt; n,GotoIf($[${ARG1} &lt;= ${DB(${KEY})}]?log)
    same =&gt; n(checkchan2),Set(KEY=Log/channel/${CUT(CHANNEL,-,1)})
    same =&gt; n,GotoIf($[${DB_EXISTS(${KEY})} = 0]?return)
    same =&gt; n,GotoIf($[${ARG1} &lt;= ${DB(${KEY})}]?log)
    same =&gt; n(return),Return()              ; Logging is not turned on return without doing anything
    same =&gt; n(log),Verbose(0,${ARG2})       ; Log the message to the console
    same =&gt; n,Return()
</pre></div>
</div>

<h3>/etc/asterisk/features.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; Asterisk Call Features (parking, transfer, etc) Configuration
; Gentlemen

[general]
  ; Nothing has been configured yet
</pre></div>
</div>

<h3>/etc/asterisk/indications.conf</h3>

<p>I never got around to configuring this file, I left the section here as the
default asterisk install adds this file in. For now you&#39;re on your own in
configuring indications.</p>

<h3>/etc/asterisk/logger.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- Logging Configuration ---
; Gentlemen

[general]
  rotatestrategy = rotate
  exec_after_rotate=gzip -9 ${filename}.2

[logfiles]
  console =&gt; notice,warning,error,dtmf
  ;full =&gt; notice,warning,error,debug,verbose,dtmf,fax
  ;verbose =&gt; notice,warning,error,verbose
  messages =&gt; notice,warning,error

  syslog.local4 =&gt; notice,warning,error
</pre></div>
</div>

<h3>/etc/asterisk/manager.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- AMI - The Asterisk Manager Interface Configuration ---
; Gentlemen

[general]
  ;bindaddr = 10.13.37.17
  enabled = no
  ;port = 5038
  webenabled = no
</pre></div>
</div>

<h3>/etc/asterisk/modules.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- Module Loader configuration file ---
; Gentlemen

[modules]
  ; I much prefer the whitelist approach of loading modules as I won't get anything that I don't need,
  ; security through simplicity
  autoload=no

  ; Uncomment the following if you wish to use the Speech Recognition API
  ;preload =&gt; res_speech.so

  ; Essential modules needed for basic operations
  load =&gt; app_dial.so           ; Used to connection channels together (i.e., make phone calls)
  load =&gt; app_stack.so          ; Provides GoSub(), GoSubIf(), Return(), StackPop(), LOCAL(),
                                ; and LOCAL_PEEK()
  load =&gt; chan_sip.so           ; Session Initiation Protocol channel driver
  load =&gt; pbx_config.so         ; This is the traditional, and most popular, dialplan language
                                ; for Asterisk. Without this module, Asterisk cannot read
                                ; extensions.conf
  load =&gt; res_rtp_asterisk.so   ; Provides RTP

  ; Security Modules
  load =&gt; cdr_adaptive_odbc.so  ; Writes CDRs through ODBC framework to a database
  load =&gt; cdr_csv.so            ; Write CDRs to a CSV file
  load =&gt; cdr_syslog.so         ; Writes CDRs to syslog
  load =&gt; res_security_log.so   ; Enables security logging

  ; Audio Codecs

  ; Recommended Order:
  ;       ulaw, alaw, gsm, g722, g726, speex

  ; Description:          A-law PCM codec used all over the world (except Canada/USA) on the PSTN
  ; Codec:                G.711 (alaw)
  ; Nominal Bandwidth:    64 kbit/s
  ; Algorithmic Latency:  0.125ms
  ; Mean Opinion Score:   4.2
  ; Fax Capable:          Yes
  ; Video Capable:        No
  load =&gt; codec_alaw.so

  ; Description:          Global System for Mobile Communications (GSM) codec
  ; Codec:                GSM-FR
  ; Nominal Bandwidth:    13 kbit/s
  ; Algorithmic Latency:
  ; Mean Opinion Score:   3.7
  ; Fax Capable:          No
  ; Video Capable:        No
  load =&gt; codec_gsm.so

  ; Description:          Wideband audio codec
  ; Codec:                G.722
  ; Nominal Bandwidth:    64 kbit/s
  ; Algorithmic Latency:
  ; Mean Opinion Score:
  ; Fax Capable:          Maybe
  ; Video Capable:        No
  load =&gt; codec_g722.so

  ; Description:          Flavor of ADPCM
  ; Codec:                G.726
  ; Nominal Bandwidth:    16-40 kbit/s
  ; Algorithmic Latency:  0.125ms
  ; Mean Opinion Score:   3.85
  ; Fax Capable:          No
  ; Video Capable:        No
  load =&gt; codec_g726.so

  ; Open source speech codec
  ; Codec:                Speex
  ; Nominal Bandwidth:    2.15-22.4 kbit/s
  ; Algorithmic Latency:  30-34ms
  ; Mean Opinion Score:
  ; Fax Capable:          No
  ; Video Capable:        No
  load =&gt; codec_speex.so

  ; Description:          Mu-law PCM codec used in Canada/USA on PSTN
  ; Codec:                G.711 (ulaw)
  ; Nominal Bandwidth:    64 kbit/s
  ; Algorithmic Latency:  0.125ms
  ; Mean Opinion Score:   4.2
  ; Fax Capable:          Yes
  ; Video Capable:        No
  load =&gt; codec_ulaw.so

  ; Audio Codec Converters
  load =&gt; codec_resample.so  ; Re-samples between 8-bit and 16-bit signed linear
  load =&gt; codec_a_mu.so      ; A-law to mu-law direct converter

  ; Format Interpreters (used to read audio files from the disk)
  load =&gt; format_ogg_vorbis.so  ; Play ogg vorbis files
  load =&gt; format_wav.so         ; Play WAV files

  ; Resources &amp; Function Modules
  load =&gt; func_cdr.so         ; Used by cdr_syslog module to format it's output
  load =&gt; func_strings.so     ; Used for security reasons on incoming calls from the PSTN lines
  load =&gt; res_adsi.so         ; Used by voicemail
  load =&gt; res_odbc.so         ; Used by the cdr_adaptive_odbc module
  load =&gt; res_musiconhold.so  ; Provides music on hold resources

  ; Voicemail
  load =&gt; app_voicemail_plain.so  ; Stores voicemails in files

  ; Production Debug Tools
  load =&gt; app_echo.so     ; Used in the echo channel to ensure two way audio is working
  load =&gt; app_verbose.so  ; Used in the various channels to send messages to the console and logs

  ; Used in various dialplans
  load =&gt; app_playback.so  ; Plays back a pre-recorded audio file

  ; For Caller ID information
  load =&gt; app_setcallerid.so
  load =&gt; func_callerid.so
</pre></div>
</div>

<h3>/etc/asterisk/musiconhold.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- Music on Hold Configuration ---
; Gentlemen

[default]
  directory = moh  ; Directory relative to the astdatadir that has the music on hold files
  mode = files     ; Read files from the configured directory
  sort = random    ; Sort the files in random order
</pre></div>
</div>

<h3>/etc/asterisk/res_odbc.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- ODBC Configuration File ---
; Gentlemen

; This 'context' name is the name that other files will reference this by
[gentlemen]
  enabled =&gt; yes                    ; Not strictly necessary but a quick way to remind myself this can
                                    ; be disabled without deleting or commenting out the whole thing
  dsn =&gt; asterisk-gentlemen         ; This value should match an entry in /etc/odbc.ini
  username =&gt; databaseuser          ; The username used to connect to the database
  password =&gt; databasepass          ; Password for connecting to the database
  pre-connect =&gt; yes                ; Open a connection as soon as asterisk starts
  idlecheck =&gt; 3600                 ; How often should we check that the database connection is still
                                    ; open? (in seconds)
  share_connections =&gt; yes          ; Allow connections to be shared, this reduces overhead but doesn't
                                    ; work on all databases
  limit =&gt; 5                        ; What is the maximum number of database connections we can have open
                                    ; at any one time?
  connect_timeout =&gt; 5              ; How long should we attempt to connect before considering the
                                    ; connection dead?
  negative_connection_cache =&gt; 300  ; When a connection fails, how long should we cache that information
                                    ; before we attempt another connection?
</pre></div>
</div>

<h3>/etc/asterisk/rtp.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- RTP Configuration ---
; Gentlemen

[general]
  rtpstart=10000
  rtpend=10100

  ;rtpchecksums=no
  ;dtmftimeout=3000
  ;rtcpinterval = 5000    ; Milliseconds between rtcp reports
                          ;(min 500, max 60000, default 5000)

  ; Enable strict RTP protection. This will drop RTP packets that
  ; do not come from the source of the RTP stream. This option is
  ; disabled by default.
  ;strictrtp=yes
</pre></div>
</div>

<h3>/etc/asterisk/sip.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>; --- SIP Configuration ---
; Gentlemen

[general]
  ; Features/SIP Defaults
  allowguest = no            ; Disable unauthenticated call
  alwaysauthreject = yes     ; Always respond as if every extension is valid, this makes brute force
                             ; scanning of extensions pointless
  canreinvite = no           ; Force all calls to be relayed through asterisk since SIP clients
                             ; outside the firewall won't be able to directly talk to internal extensions
  context = unauthenticated  ; Default context for incoming calls
  dtmfmode = auto            ; Automatically detect the DTMF tranmission type
  srvlookup = no             ; Disable DNS SRV record lookup on outbound calls
  videosupport = yes         ; May be useful later when setting up video calls

  ; Network options
  bindport = 5060                      ; Explicitely bind to the default SIP port
  externip = x.x.x.x                   ; The current external IP address of The Gentlemens Lounge
  localnet = 10.13.37.0/255.255.255.0  ; Our internal subnet
  tcpenable = yes                      ; We'll allow incoming connections via TCP as well
  udpbindaddr = 10.13.37.xx            ; Listen for UDP requests on the primary interface

  ; Encryption settings
  tlsenable = yes                          ; Turn encryption support on
  tlsbindbindaddr = 10.13.37.xx            ; Listen for encrypted calls on the primary interface
  tlscafile = /var/lib/asterisk/ca.crt     ; Certificate authority's cert
  tlscertfile = /var/lib/asterisk/pbx.pem  ; This server's private key and certificate

  ; Clear the list of codecs
  disallow = all

  ; Set a default order for our codecs, providing all of them will increase compatibility with other
  ; internet clients. Notes on the quality tradeoff can be found in the module.conf file where these
  ; codecs are loaded
  allow = ulaw
  allow = alaw
  allow = gsm
  allow = g722
  allow = g726
  allow = speex
  allow = g729

; Template to restrict SIP users to only the local network
[localonly](!)
  ; Start by denying everyone
  deny = 0.0.0.0/0.0.0.0
  ; Allow connetion that originate from 10.13.37.X to attempt to authenticate against this account
  permit = 10.13.37.0/255.255.255.0

; A template for VoIP extensions that might connect from the outside
[sipclient](!)
  context = internal  ; They should be in our internal context
  host = dynamic      ; The clients will not be static (they could be anywhere)
  type = friend       ; User type
  qualify = yes       ; Talk to them frequently to make sure they're still there (and too hold
                      ; firewall connections open)

; Slight adjustment of the sipclient template to adjust that these extensions will be connecting from the outside
[roadwarrior](!,sipclient)
  nat = yes  ; Yes, they're probably on the other side of our NAT

; This is specifically for my SPA-3000, I've found that even though my device has a static addresses
; I should leave the host type as dynamic as registrations cause errors in the asterisk log, I suppose it
; would be possible to configure the LINE and PSTNIN as peers and turn off registrations in the Sipura's
; configuration, which might be the better route to go. I will have to investigate this in the future but
; this works for now.
[atadevice](!,sipclient,localonly)
  nat = never  ; These devices should never be outside our NAT

; Configuration for internal POTS line on the Linksys SPA-3000
[SPA3000_LINE](atadevice)
  context = internal
  port = 5060
  secret = setyourownpassword

; Configuration for incoming phone calls from the POTS line through the SPA-3000
[SPA3000_PSTNIN](atadevice)
  context = pstnmenu
  secret = setyourownpassword

; Configuration for incoming telephone line on the Linksys SPA-3000
[SPA3000_PSTNOUT](atadevice)
  context = from-trunk
  default-user = from-pbx
  host = 10.13.37.xx
  port = 5061
  secret = setyourownpassword

; SIP Users, these should have especially strong passwords. I use the following to generate
; passwords for them:
;      dd if=/dev/random count=2 bs=8 2&gt;/dev/null | base64 | sed -e 's/=*$//'
; It will create passwords like:
;      9VkLRZz0s9GNFcAica0ONA
;      SOhiPwA0pTupjFx/QCu7BA
;      5Zw+5B8435lrMLKvsSNVpQ
[user1](roadwarrior)
  callerid = &quot;User 1&quot;
  secret = setyourownpassword

[user2](roadwarrior)
  callerid =&quot;User 2&quot;
  secret = setyourownpassword

[user3](roadwarrior)
  callerid = &quot;User 3&quot;
  secret = setyourownpassword
</pre></div>
</div>

<h3>/etc/odbc.ini</h3>
<div class="CodeRay">
  <div class="code"><pre>[asterisk-gentlemen]
Description = Database driver for Asterisk call logs
Trace       = Off
TraceFile   = stderr
Driver      = MySQL
SERVER      = mysqlserver.localhost
PORT        = 3306
DATABASE    = gentlemen
</pre></div>
</div>

<p>Here is the schema for the table that I use:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="comment">--
-- Database: `gentlemen`</span>
<span class="comment">--
</span>
<span class="comment">-- --------------------------------------------------------</span>

<span class="comment">--
-- Table structure for table `asterisk`</span>
<span class="comment">--
</span>
<span class="class">DROP</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string"><span class="delimiter">`</span><span class="content">asterisk</span><span class="delimiter">`</span></span>;
<span class="class">CREATE</span> <span class="type">TABLE</span> <span class="string"><span class="delimiter">`</span><span class="content">asterisk</span><span class="delimiter">`</span></span> (
  <span class="string"><span class="delimiter">`</span><span class="content">call_id</span><span class="delimiter">`</span></span> <span class="predefined-type">int</span>(<span class="integer">10</span>) <span class="predefined-type">unsigned</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">AUTO_INCREMENT</span>,
  <span class="string"><span class="delimiter">`</span><span class="content">accountcode</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">An account ID. This field is user-defined and is empty by default.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">src</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The calling party’s caller ID number. It is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">dst</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The destination extension for the call. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">dcontext</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The destination context for the call. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">clid</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The full caller ID, including the name, of the calling party. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">channel</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The calling party’s channel. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">dstchannel</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The called party’s channel. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">lastapp</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The last dialplan application that was executed. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">lastdata</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The arguments passed to the lastapp. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">start</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The start time of the call. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">answer</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The answered time of the call. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">end</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The end time of the call. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">duration</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The number of seconds between the start and end times for the call. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">billsec</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The number of seconds between the answer and end times for the call. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">disposition</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">An indication of what happened to the call. This may be NO ANSWER, FAILED, BUSY, ANSWERED, or UNKNOWN.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">amaflags</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The Automatic Message Accounting (AMA) flag associated with this call. This may be one of the following: OMIT, BILLING, DOCUMENTATION, or Unknown.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">userfield</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="directive">DEFAULT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">A general-purpose user field. This field is empty by default and can be set to a user-defined string.</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">`</span><span class="content">uniqueid</span><span class="delimiter">`</span></span> <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="class">COMMENT</span> <span class="string"><span class="delimiter">'</span><span class="content">The unique ID for the src channel. This field is set automatically and is read-only.</span><span class="delimiter">'</span></span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (<span class="string"><span class="delimiter">`</span><span class="content">call_id</span><span class="delimiter">`</span></span>)
) <span class="directive">ENGINE</span>=MyISAM  <span class="directive">DEFAULT</span> <span class="directive">CHARSET</span>=latin1 ;
</pre></div>
</div>

<h2>Music On Hold</h2>

<p>The way that music on hold is configured in the dial plan on this page it will
look for files in the directory <code>/usr/share/asterisk/moh/</code>. Files will be
chosen at random from this directory as long as asterisk can read them (that is
it has a codec for the audio file loaded). I strongly suggest the music be in
<code>ogg</code> format.</p>

<h2>Configuring Linksys/Sipura SPA-3000</h2>

<p>I&#39;ve documented setting up the <a href="../../devices/sipura_spa3000/">Linksys Sipura SPA3000</a> with Asterisk on
another section of my wiki.</p>

<h2>Text to Speech</h2>

<p>Please refer to my notes on <a href="../festival/">Festival</a> for more information on text to
speech with asterisk.</p>

    </div>
  </body>
</html>
