<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Xen - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Xen" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/xen/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Xen</h1>

<p>Full Xen dom0 support was added in the Linux 3.0 kernel. This means there&#39;s no
longer a need to drag patches forward from old kernels and work from special
branches and git repositories when building a kernel for dom0.</p>

<p>Something else you might not have noticed is that the Fedora kernel team has
quietly slipped Linux 3.0 into Fedora 15&#39;s update channels in disguise. Click
that link, scroll down, and you&#39;ll see &quot;Rebase to 3.0. Version reports as
2.6.40 for compatibility with older userspace.&quot; Although I&#39;m not a fan of
calling something what it isn&#39;t (2.6.40 doesn&#39;t exist on kernel.org), I can
understand some of the reasoning behind the choice.</p>

<p>This change makes the Xen installation on Fedora 15 pretty trivial. To get
started, update your kernel to the latest if you&#39;re not already on Fedora&#39;s
2.6.40 kernels:</p>
<div class="CodeRay">
  <div class="code"><pre>yum -y upgrade kernel
</pre></div>
</div>

<p>We need three more packages (quite a few dependencies will roll in with them):</p>
<div class="CodeRay">
  <div class="code"><pre>yum -y install xen libvirt python-virtinst
</pre></div>
</div>

<p>The xen package reels in the hypervisor itself along with libraries and command
line tools (like xl and xm). Libvirt gives us easy access to VM management with
the virsh command and python-virtinst gives us the handy virt-install command
to make OS installations easy.</p>

<p>Once those packages are installed, we need to make some adjustments in your
grub configuration. Open /boot/grub/menu.lst in your text editor of choice and
add something like this at the bottom:</p>
<div class="CodeRay">
  <div class="code"><pre>title Fedora + Xen (2.6.40-4.fc15.x86_64)
        root (hd0,1)
  kernel /boot/xen.gz
        module /boot/vmlinuz-2.6.40-4.fc15.x86_64 ro root=/dev/sda1
        module /boot/initramfs-2.6.40-4.fc15.x86_64.img
</pre></div>
</div>

<p>Ensure that the root (hd0,1) is applicable to your system (adjust it if it
isn&#39;t). Also, check the kernel version to ensure it matches your installed
kernel and adjust the root= portion to match your root volume. Flip the default
line to a value which will boot your new grub entry and ensure the timeout is
set to a reasonable number if you need to temporarily switch back to your
original grub entry at boot time. (Hey, we all make mistakes.)</p>

<p>I take one extra precaution and change the UPDATEDEFAULT=yes line to no in
<code>/etc/sysconfig/kernel</code>. This ensures that future kernel updates don&#39;t trample
the entry you&#39;ve just made. Keep in mind that you&#39;ll need to manually update
your grub configuration when you do kernel upgrades later.</p>

<p>Cross your fingers and reboot. If your system doesn&#39;t reboot properly, reboot
it again and choose your old kernel from the grub menu. Double-check your
configuration for fat-fingering and give it another try. If your system boots
and pings but you have no output via a monitor, don&#39;t fret. There&#39;s a patch for
the problem which should appear soon in Linux 3.0. The impatient can snag a
kernel source RPM, add the patch file, and build a local kernel (or you can
download my local build from when I did it).</p>

<p>Log in and verify that you booted into the dom0:</p>
<div class="CodeRay">
  <div class="code"><pre>[root@xenbox ~]# xm dmesg | head -n 5
 __  __            _  _    _   _   ____     __      _ ____  
 \ \/ /___ _ __   | || |  / | / | |___ \   / _| ___/ | ___| 
  \  // _ \ '_ \  | || |_ | | | |__ __) | | |_ / __| |___ \ 
  /  \  __/ | | | |__   _|| |_| |__/ __/ _|  _| (__| |___) |
 /_/\_\___|_| |_|    |_|(_)_(_)_| |_____(_)_|  \___|_|____/
</pre></div>
</div>

<p>Once you&#39;re done with that, make sure libvirtd is running:</p>
<div class="CodeRay">
  <div class="code"><pre>/etc/init.d/libvirtd start
chkconfig libvirtd on
</pre></div>
</div>

<p>Try installing a VM:</p>
<div class="CodeRay">
  <div class="code"><pre>virt-install \
  --paravirt \
  --name=testvm \
  --ram=512 \
  --vcpus=4 \
  --file /dev/vmstorage/testvm \
  --graphics vnc,port=5905 --noautoconsole \
  --autostart --noreboot \
  --location=http://mirrors.kernel.org/debian/dists/squeeze/main/installer-amd64/
</pre></div>
</div>

<p>You should have a VM installation underway pretty quickly and it will be
visible via port 5905 on the local host. Enjoy the power and freedom of your
brand new type 1 hypervisor.</p>

<p><a href="http://fclose.com/b/linux/2258/managing-xen-dom0s-cpu-and-memory/">Additional notes about dom0&#39;s CPU and memory</a></p>

    </div>
  </body>
</html>
