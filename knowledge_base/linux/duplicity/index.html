<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Duplicity - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Duplicity" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/duplicity/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git io:repos/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Duplicity</h1>

<p>Duplicity is a command line backup utility that makes use of the rsync
libraries to perform incremental backups. It also can use GPG public/private
keypairs to handle backing up and restoring files.</p>

<p>I personally want to use public / private key pairs for my backups and contrary
with what I do most of the time I share a single public / private key pair for
my backups, with a strong pass string on the private key.</p>

<p>This is an adequate level of security for me as the backups will all be
encrypted and can be decrypted and restored from any of the other machines as
needed.</p>

<p>The backups are performed to a remote system using SFTP and thus I handle
per-machine authentication using SSH keys (the setup of which I have documented
on the page for <a href="../../devices/nslu2/">my NSLU2 NAS</a>).</p>

<p>Duplicity supports more than SFTP as a backend, however, it will just make my
scripts less relevant too you.</p>

<h2>Installation</h2>

<p>Fedora happily has a package available so this is as easy as:</p>
<div class="CodeRay">
  <div class="code"><pre>sudo yum install duplicity python-paramiko -y
</pre></div>
</div>

<p>It also happily doesn&#39;t have a whole lot of dependencies.</p>

<p>You&#39;ll also need GPG installed if you want to make use of my scripts, this
won&#39;t trample on any GPG setup you may currently have. On Fedora this is
provided with the gpgme package and can be installed like so:</p>
<div class="CodeRay">
  <div class="code"><pre>sudo yum install gpgme -y
</pre></div>
</div>

<p>I also strongly recommend you install and configure <a href="../rng_tools/">rng-tools</a> on any
machine getting backed up that is headless with little to no user interaction,
as the encryption requires a lot of entropy.</p>

<h3>GPG Key Creation</h3>

<p>You&#39;ll only need to perform this process once, afterwards you&#39;ll have the
exported keys to move and backup as you please. I&#39;ve chosen to use a 4096 bit
RSA and RSA key that doesn&#39;t expire and has the name &quot;System Backups&quot; without
an email address or a comment.</p>

<p>I&#39;ve also set a very long pass string on the key as you&#39;ll be relying on this
to protect all the data on all your systems you&#39;ll be backing up with this.
These settings are of course personal preference and a 4096 bit key may be
overkill for most uses, though I really enjoy overkill when it comes to
security and peace of mind.</p>
<div class="CodeRay">
  <div class="code"><pre>gpg --keyring backup-pub.gpg --secret-keyring backup-sec.gpg \
  --no-default-keyring --gen-key
</pre></div>
</div>

<p>Now we need a way to securely move the generated keys around without worrying
about. I&#39;ve chosen to export the public and private keys, encrypt them with a
symmetric pass string and move the resulting file between machines.</p>

<p>The private key should be encrypted anyway but it&#39;s one extra layer that can be
added on that allows me to feel comfortable enough to leave the whole blob in
the script without fear of compromising the private key in case that gets
cracked.</p>

<p>I refer to this password as the &quot;installation key&quot; as the script will use it to
decrypt and import the keys into the local GPG on other machines.</p>

<p>First you&#39;ll need to get the key ID of the key we just generated. This can be
done like so:</p>
<div class="CodeRay">
  <div class="code"><pre>gpg --keyring backup-pub.gpg --list-keys
/home/user/.gnupg/backup-pub.gpg
------------------------------------
pub   4096R/01234567 2012-09-24
uid                  System Backups
sub   4096R/89ABCDEF 2012-09-24
</pre></div>
</div>

<p>Given the output above our key ID is <code>01234567</code>, you&#39;ll want to replace that in
the following commands with your own key ID. First we&#39;ll export the public key,
there isn&#39;t any security concerns here:</p>
<div class="CodeRay">
  <div class="code"><pre>gpg --keyring backup-pub.gpg --output backup-pubkey.gpg --export 01234567
</pre></div>
</div>

<p>You now have the public key in the file <code>backup-pubkey.gpg</code>. Now we&#39;re going to
export the private key without saving it, combine it with the public key, and
encrypt the whole shebang into one file. Watch closely...</p>
<div class="CodeRay">
  <div class="code"><pre>gpg --secret-keyring backup-sec.gpg --export-secret-key 01234567 |
  cat backup-pubkey.gpg - | gpg --armor --symmetric --cipher-algo AES256 \
  --output backup-keys.asc
</pre></div>
</div>

<p>You now have a block of base64 encoded encrypted goodness in the
<code>backup-keys.asc</code> file which you can import later on.</p>

<h3>GPG Key Import</h3>
<div class="CodeRay">
  <div class="code"><pre>cat export.asc | gpg2 --decrypt --batch --passphrase &quot;PASSWORD&quot; | gpg2 \
  --keyring backup-pub.gpg --secret-keyring backup-sec.gpg --import
</pre></div>
</div>

    </div>
  </body>
</html>
