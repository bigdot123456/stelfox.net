<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>MySQL Tuning - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="MySQL Tuning" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/mysql_tuning/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git io:repos/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>MySQL Tuning</h1>
<div class="CodeRay">
  <div class="code"><pre>#!/bin/sh

# MySQL performance tuning primer script
#
# Writen by:      Matthew Montgomery
# Modified by:    Sam Stelfox
# Report bugs to: https://bugs.launchpad.net/mysql-tuning-primer
# Inspired by:    MySQLARd (http://gert.sos.be/demo/mysqlar/)
# Version:        1.6-r1
# Released:       2011-08-06
# Updated:        2013-05-23
#
# Licenced under GPLv2.
#
# Usage: ./tuning-primer.sh [mode]
#
# Available Modes:
#   all:         perform all checks (default)
#   prompt:      prompt for login credintials and socket and execution mode.
#   mem, memory: run checks for tunable options which effect memory usage.
#   disk, file:  run checks for options which effect i/o performance or file
#                handle limits
#   innodb:      run InnoDB checks, to be improved
#   misc:        run checks for that don't categorise well slow queries, binary
#                logs, used connections and worker threads.

# Set this socket variable ONLY if you have multiple instances running or we
# are unable to find your socket, and you don't want to to be prompted for
# input each time you run this script.
socket=

# Nice and easy names for the various colors
export black='\033[0m'
export boldblack='\033[1;0m'
export red='\033[31m'
export boldred='\033[1;31m'
export green='\033[32m'
export boldgreen='\033[1;32m'
export yellow='\033[33m'
export boldyellow='\033[1;33m'
export blue='\033[34m'
export boldblue='\033[1;34m'
export magenta='\033[35m'
export boldmagenta='\033[1;35m'
export cyan='\033[36m'
export boldcyan='\033[1;36m'
export white='\033[37m'
export boldwhite='\033[1;37m'

# Function to easliy print colored text
#   Argument $1 = message
#   Argument $2 = color
cecho() {
  local default_msg=&quot;No message passed.&quot;
  message=${1:-$default_msg}

  # Change it for fun, we use pure names. Defaults to black, if not specified.
  color=${2:-black}

  case $color in
    black)
      printf &quot;$black&quot;;;
    boldblack)
      printf &quot;$boldblack&quot;;;
    red)
      printf &quot;$red&quot;;;
    boldred)
      printf &quot;$boldred&quot;;;
    green)
      printf &quot;$green&quot;;;
    boldgreen)
      printf &quot;$boldgreen&quot;;;
    yellow)
      printf &quot;$yellow&quot;;;
    boldyellow)
      printf &quot;$boldyellow&quot;;;
    blue)
      printf &quot;$blue&quot;;;
    boldblue)
      printf &quot;$boldblue&quot;;;
    magenta)
      printf &quot;$magenta&quot;;;
    boldmagenta)
      printf &quot;$boldmagenta&quot;;;
    cyan)
      printf &quot;$cyan&quot;;;
    boldcyan)
      printf &quot;$boldcyan&quot;;;
    white)
      printf &quot;$white&quot;;;
    boldwhite)
      printf &quot;$boldwhite&quot;;;
  esac

  printf &quot;%s&quot; &quot;$message&quot;
  tput sgr0 # Reset all the colors back to normal.
  printf &quot;$black&quot;

  return
}

# Function to easliy print colored text without a newline
#   Argument $1 = message
#   Argument $2 = color
cechon() {
  local default_msg=&quot;No message passed.&quot;
  message=${1:-$default_msg}

  color=${2:-black}

  case $color in
    black)
      printf &quot;$black&quot;;;
    boldblack)
      printf &quot;$boldblack&quot;;;
    red)
      printf &quot;$red&quot;;;
    boldred)
      printf &quot;$boldred&quot;;;
    green)
      printf &quot;$green&quot;;;
    boldgreen)
      printf &quot;$boldgreen&quot;;;
    yellow)
      printf &quot;$yellow&quot;;;
    boldyellow)
      printf &quot;$boldyellow&quot;;;
    blue)
      printf &quot;$blue&quot;;;
    boldblue)
      printf &quot;$boldblue&quot;;;
    magenta)
      printf &quot;$magenta&quot;;;
    boldmagenta)
      printf &quot;$boldmagenta&quot;;;
    cyan)
      printf &quot;$cyan&quot;;;
    boldcyan)
      printf &quot;$boldcyan&quot;;;
    white)
      printf &quot;$white&quot;;;
    boldwhite)
      printf &quot;$boldwhite&quot;;;
  esac

  printf &quot;%s&quot; &quot;$message&quot;
  tput sgr0 # Reset all the colors back to normal.
  printf &quot;$black&quot;

  return
}

# Banner
print_banner() {
  cecho &quot; -- MYSQL PERFORMANCE TUNING PRIMER --&quot; boldblue
  cecho &quot;      - By: Matthew Montgomery -&quot; black
  cecho &quot;   - Modifications By: Sam Stelfox -&quot; black
}

# Find the location of the mysql.sock file
check_for_socket() {
  if [ -z &quot;$socket&quot; ]; then
    # Use ~/my.cnf version
    if [ -f ~/.my.cnf ]; then
      cnf_socket=$(grep ^socket ~/.my.cnf | awk -F \= '{ print $2 }' | head -1)
    fi

    if [ -S &quot;$cnf_socket&quot; ]; then
      socket=$cnf_socket
    elif [ -S /var/lib/mysql/mysql.sock ]; then
      socket=/var/lib/mysql/mysql.sock
    elif [ -S /var/run/mysqld/mysqld.sock ]; then
      socket=/var/run/mysqld/mysqld.sock
    elif [ -S /tmp/mysql.sock ]; then
      socket=/tmp/mysql.sock
    else
      if [ -S &quot;$ps_socket&quot; ]; then
        socket=$ps_socket
      fi
    fi
  fi

  if [ -S &quot;$socket&quot; ]; then
    echo UP &gt; /dev/null
  else
    cecho 'No valid socket file &quot;$socket&quot; found!' boldred
    cecho 'The mysqld process is not running or it is installed in a custom location.' red
    cecho 'If you are sure mysqld is running, execute script in &quot;prompt&quot; mode or set' red
    cecho 'the socket= variable at the top of this script' red
    exit 1
  fi
}

# Check for the existance of plesk and login using it's credentials
check_for_plesk_passwords() {
  if [ -f /etc/psa/.psa.shadow ]; then
    mysql=&quot;mysql -S $socket -u admin -p$(cat /etc/psa/.psa.shadow)&quot;
    mysqladmin=&quot;mysqladmin -S $socket -u admin -p$(cat /etc/psa/.psa.shadow)&quot;
  else
    mysql=&quot;mysql&quot;
    mysqladmin=&quot;mysqladmin&quot;
  fi
}

# Test for running mysql
check_mysql_login() {
  is_up=$($mysqladmin ping 2&gt;&amp;1)

  if [ &quot;$is_up&quot; = &quot;mysqld is alive&quot; ]; then
    echo UP &gt; /dev/null
  elif [ &quot;$is_up&quot; != &quot;mysqld is alive&quot; ]; then
    printf &quot;\n&quot;
    cecho &quot;Using login values from ~/.my.cnf&quot;
    cecho &quot;- INITIAL LOGIN ATTEMPT FAILED -&quot; boldred

    if [ -z $prompted ]; then
      find_webmin_passwords
    else
      return 1
    fi
  else
    cecho &quot;Unknow exit status&quot; red
    exit -1
  fi
}

final_login_attempt() {
  is_up=$($mysqladmin ping 2&gt;&amp;1)

  if [ &quot;$is_up&quot; = &quot;mysqld is alive&quot; ]; then
    echo UP &gt; /dev/null
  elif [ &quot;$is_up&quot; != &quot;mysqld is alive&quot; ]; then
    cecho &quot;- FINAL LOGIN ATTEMPT FAILED -&quot; boldred
    cecho &quot;Unable to log into socket: $socket&quot; boldred

    exit 1
  fi
}

# Create a ~/.my.cnf and exit when all else fails
second_login_failed() {
  cecho &quot;Could not auto detect login info!&quot;
  cecho &quot;Found potential sockets: $found_socks&quot;
  cecho &quot;Using: $socket&quot; red

  read -p &quot;Would you like to provide a different socket?: [y/N] &quot; REPLY

  case $REPLY in
    yes|y|Y|YES)
      read -p &quot;Socket: &quot; socket ;;
  esac

  read -p &quot;Do you have your login handy?: [y/N] &quot; REPLY

  case $REPLY in
    yes|y|Y|YES)
      answer1='yes'
      read -p &quot;User: &quot; user
      read -rp &quot;Password: &quot; pass

      if [ -z $pass ] ; then
        export mysql=&quot;$mysql -S$socket -u$user&quot;
        export mysqladmin=&quot;$mysqladmin -S$socket -u$user&quot;
      else
        export mysql=&quot;$mysql -S$socket -u$user -p$pass&quot;
        export mysqladmin=&quot;$mysqladmin -S$socket -u$user -p$pass&quot;
      fi
      ;;
    *)
      cecho &quot;Please create a valid login to MySQL&quot;
      cecho &quot;Or, set correct values for  'user=' and 'password=' in ~/.my.cnf&quot;
      ;;
  esac

  cecho &quot; &quot;
  read -p &quot;Would you like me to create a ~/.my.cnf file for you?: [y/N] &quot; REPLY

  case $REPLY in
    yes|y|Y|YES)
      answer2='yes'

      if [ ! -f ~/.my.cnf ] ; then
        umask 077
        printf &quot;[client]\nuser=$user\npassword=$pass\nsocket=$socket&quot; &gt; ~/.my.cnf

        if [ &quot;$answer1&quot; != 'yes' ] ; then
          exit 1
        else
          final_login_attempt
          return 0
        fi
      else
        printf &quot;\n&quot;
        cecho &quot;~/.my.cnf already exists!&quot; boldred
        printf &quot;\n&quot;
        read -p &quot;Replace?: [y/N] &quot; REPLY

        if [ &quot;$REPLY&quot; = 'y' ] || [ &quot;$REPLY&quot; = 'Y' ] ; then
          printf &quot;[client]\nuser=$user\npassword=$pass\socket=$socket&quot; &gt; ~/.my.cnf

          if [ &quot;$answer1&quot; != 'yes' ] ; then
            exit 1
          else
            final_login_attempt
            return 0
          fi
        else
          cecho &quot;Please set the 'user=' and 'password=' and 'socket=' values in ~/.my.cnf&quot;
          exit 1
        fi
      fi
      ;;
    *)
      if [ &quot;$answer1&quot; != 'yes' ] ; then
        exit 1
      else
        final_login_attempt
        return 0
      fi
      ;;
  esac
}

# Populate the .my.cnf file using values harvested from Webmin
find_webmin_passwords() {
  cecho &quot;Testing for stored webmin passwords:&quot;

  if [ -f /etc/webmin/mysql/config ]; then
    user=$(grep ^login= /etc/webmin/mysql/config | cut -d &quot;=&quot; -f 2)
    pass=$(grep ^pass= /etc/webmin/mysql/config | cut -d &quot;=&quot; -f 2)

    if [  $user ] &amp;&amp; [ $pass ] &amp;&amp; [ ! -f ~/.my.cnf  ]; then
      cecho &quot;Setting login info as User: $user Password: $pass&quot;
      touch ~/.my.cnf
      chmod 600 ~/.my.cnf

      printf &quot;[client]\nuser=$user\npassword=$pass&quot; &gt; ~/.my.cnf 
      cecho &quot;Retrying login&quot;
      is_up=$($mysqladmin ping 2&gt;&amp;1)

      if [ &quot;$is_up&quot; = &quot;mysqld is alive&quot; ]; then
        echo UP &gt; /dev/null
      else
        second_login_failed
      fi

      echo
    else
      second_login_failed
      echo
    fi
  else
    cecho &quot; None Found&quot; boldred
    second_login_failed
  fi
}

# Function to pull MySQL status variable
#
# Ex:
#     mysql_status 'Mysql_status_variable' bash_dest_variable
mysql_status() {
  local status=$($mysql -Bse &quot;show /*!50000 global */ status like $1&quot; | awk '{ print $2 }')
  export &quot;$2&quot;=$status
}

# Function to pull MySQL server runtime variable
#
# Ex:
#     mysql_variable 'Mysql_server_variable' bash_dest_variable
#     mysql_variableTSV 'Mysql_server_variable' bash_dest_variable
mysql_variable() {
  local variable=$($mysql -Bse &quot;show /*!50000 global */ variables like $1&quot; | awk '{ print $2 }')
  export &quot;$2&quot;=$variable
}

mysql_variableTSV() {
  local variable=$($mysql -Bse &quot;show /*!50000 global */ variables like $1&quot; | awk -F \t '{ print $2 }')
  export &quot;$2&quot;=$variable
}

float2int() {
  local variable=$(echo &quot;$1 / 1&quot; | bc -l)
  export &quot;$2&quot;=$variable
}

# Divide two integers
divide() {
  usage=&quot;$0 dividend divisor '$variable' scale&quot;

  if [ $1 -ge 1 ]; then
    dividend=$1
  else
    cecho &quot;Invalid Dividend&quot; red
    echo $usage
    exit 1
  fi

  if [ $2 -ge 1 ]; then
    divisor=$2
  else
    cecho &quot;Invalid Divisor&quot; red
    echo $usage
    exit 1
  fi

  if [ ! -n $3 ]; then
    cecho &quot;Invalid variable name&quot; red
    echo $usage
    exit 1
  fi

  if [ -z $4 ]; then
    scale=2
  elif [ $4 -ge 0 ]; then
    scale=$4
  else
    cecho &quot;Invalid scale&quot; red
    echo $usage
    exit 1
  fi

  export $3=$(echo &quot;scale=$scale; $dividend / $divisor&quot; | bc -l)
}

# Convert a value in to human readable size and populate a variable with the
# result.
#
# value=$1
# variable=$2
#
# Ex:
#     human_readable $value 'variable name' [places of precision]
human_readable() {
  scale=$3

  if [ $1 -ge 1073741824 ]; then
    if [ -z $3 ]; then
      scale=2
    fi

    divide $1 1073741824 &quot;$2&quot; $scale
    unit=&quot;G&quot;
  elif [ $1 -ge 1048576 ]; then
    if [ -z $3 ]; then
      scale=0
    fi

    divide $1 1048576 &quot;$2&quot; $scale
    unit=&quot;M&quot;
  elif [ $1 -ge 1024 ]; then
    if [ -z $3 ]; then
      scale=0
    fi

    divide $1 1024 &quot;$2&quot; $scale
    unit=&quot;K&quot;
  else
    export &quot;$2&quot;=$1
    unit=&quot;bytes&quot;
  fi
}

# Function to produce human readable time
human_readable_time() {
  usage=&quot;$0 seconds 'variable'&quot;

  if [ -z $1 ] || [ -z $2 ] ; then
    cecho $usage red
    exit 1
  fi

  days=$(echo &quot;scale=0 ; $1 / 86400&quot; | bc -l)
  remainder=$(echo &quot;scale=0 ; $1 % 86400&quot; | bc -l)
  hours=$(echo &quot;scale=0 ; $remainder / 3600&quot; | bc -l)
  remainder=$(echo &quot;scale=0 ; $remainder % 3600&quot; | bc -l)
  minutes=$(echo &quot;scale=0 ; $remainder / 60&quot; | bc -l)
  seconds=$(echo &quot;scale=0 ; $remainder % 60&quot; | bc -l)

  export $2=&quot;$days days $hours hrs $minutes min $seconds sec&quot;
}

# Print version info
check_mysql_version() {
  mysql_variable \'version\' mysql_version
  mysql_variable \'version_compile_machine\' mysql_version_compile_machine

  if [ &quot;$mysql_version_num&quot; -lt 050000 ]; then
    cecho &quot;MySQL Version $mysql_version $mysql_version_compile_machine is EOL please upgrade to MySQL 4.1 or later&quot; boldred
  else
    cecho &quot;MySQL Version $mysql_version $mysql_version_compile_machine&quot;
  fi
}

# Present a reminder that mysql must run for a couple of days to build up good
# numbers in server status variables before these tuning suggestions should be
# used.
post_uptime_warning() {
  mysql_status \'Uptime\' uptime
  mysql_status \'Threads_connected\' threads
  queries_per_sec=$(($questions/$uptime))
  human_readable_time $uptime uptimeHR

  cecho &quot;Uptime = $uptimeHR&quot;
  cecho &quot;Avg. qps = $queries_per_sec&quot;
  cecho &quot;Total Questions = $questions&quot;
  cecho &quot;Threads Connected = $threads&quot;
  echo

  if [ $uptime -gt 172800 ] ; then
    cecho &quot;Server has been running for over 48hrs.&quot;
    cecho &quot;It should be safe to follow these recommendations&quot;
  else
    cechon &quot;Warning: &quot; boldred
    cecho &quot;Server has not been running for at least 48hrs.&quot; boldred
    cecho &quot;It may not be safe to use these recommendations&quot; boldred
  fi

  echo &quot;&quot;
  cecho &quot;To find out more information on how each of these&quot; red
  cecho &quot;runtime variables effects performance visit:&quot; red

  if [ &quot;$major_version&quot; = '3.23' ] || [ &quot;$major_version&quot; = '4.0' ] || [ &quot;$major_version&quot; = '4.1' ] ; then
    cecho &quot;http://dev.mysql.com/doc/refman/4.1/en/server-system-variables.html&quot; boldblue
  elif [ &quot;$major_version&quot; = '5.0' ] || [ &quot;$mysql_version_num&quot; -gt '050100' ]; then
    cecho &quot;http://dev.mysql.com/doc/refman/$major_version/en/server-system-variables.html&quot; boldblue
  else
    cecho &quot;UNSUPPORTED MYSQL VERSION&quot; boldred
    exit 1
  fi

  cecho &quot;Visit http://www.mysql.com/products/enterprise/advisors.html&quot; boldblue
  cecho &quot;for info about MySQL's Enterprise Monitoring and Advisory Service&quot; boldblue
}

# Slow Queries
check_slow_queries () {
  cecho &quot;SLOW QUERIES&quot; boldblue

  mysql_status \'Slow_queries\' slow_queries
  mysql_variable \'long_query_time\' long_query_time
  mysql_variable \'log%queries\' log_slow_queries

  prefered_query_time=5

  if [ -e /etc/my.cnf ]; then
    if [ -z $log_slow_queries ]; then
      log_slow_queries=$(grep log-slow-queries /etc/my.cnf)
    fi
  fi

  if [ &quot;$log_slow_queries&quot; = 'ON' ]; then
    cecho &quot;The slow query log is enabled.&quot;
  elif [ &quot;$log_slow_queries&quot; = 'OFF' ]; then
    cechon &quot;The slow query log is &quot;
    cechon &quot;NOT&quot; boldred
    cecho &quot; enabled.&quot;
  elif [ -z $log_slow_queries ]; then
    cechon &quot;The slow query log is &quot;
    cechon &quot;NOT&quot; boldred
    cecho &quot; enabled.&quot;
  else
    cecho &quot;Error: $log_slow_queries&quot; boldred
  fi

  cecho &quot;Current long_query_time = $long_query_time sec.&quot;
  cechon &quot;You have &quot;
  cechon &quot;$slow_queries&quot; boldred 
  cechon &quot; out of &quot;
  cechon &quot;$questions&quot; boldred
  cecho &quot; that take longer than $long_query_time sec. to complete&quot;

  float2int long_query_time long_query_timeInt

  if [ $long_query_timeInt -gt $prefered_query_time ]; then
    cecho &quot;Your long_query_time may be too high, I typically set this under $prefered_query_time sec.&quot; red
  else
    cecho &quot;Your long_query_time seems to be fine&quot; green
  fi
}

# Binary Log
check_binary_log() {
  cecho &quot;BINARY UPDATE LOG&quot; boldblue

  mysql_variable \'log_bin\' log_bin
  mysql_variable \'max_binlog_size\' max_binlog_size
  mysql_variable \'expire_logs_days\' expire_logs_days
  mysql_variable \'sync_binlog\' sync_binlog
  #mysql_variable \'max_binlog_cache_size\' max_binlog_cache_size

  if [ &quot;$log_bin&quot; = 'ON' ]; then
    cecho &quot;The binary update log is enabled&quot;

    if [ -z &quot;$max_binlog_size&quot; ]; then
      cecho &quot;The max_binlog_size is not set. The binary log will rotate when it reaches 1GB.&quot; red
    fi

    if [ &quot;$expire_logs_days&quot; -eq 0 ]; then
      cecho &quot;The expire_logs_days is not set.&quot; boldred
      cechon &quot;The mysqld will retain the entire binary log until &quot; red
      cecho &quot;RESET MASTER or PURGE MASTER LOGS commands are run manually&quot; red
      cecho &quot;Setting expire_logs_days will allow you to remove old binary logs automatically&quot;  yellow
      cecho &quot;See http://dev.mysql.com/doc/refman/$major_version/en/purge-master-logs.html&quot; yellow
    fi

    if [ &quot;$sync_binlog&quot; = 0 ] ; then
      cecho &quot;Binlog sync is not enabled, you could loose binlog records during a server crash&quot; red
    fi
  else
    cechon &quot;The binary update log is &quot;
    cechon &quot;NOT &quot; boldred
    cecho &quot;enabled.&quot;
    cecho &quot;You will not be able to do point in time recovery&quot; red
    cecho &quot;See http://dev.mysql.com/doc/refman/$major_version/en/point-in-time-recovery.html&quot; yellow
  fi
}

# Used Connections
check_used_connections() {
  mysql_variable \'max_connections\' max_connections
  mysql_status \'Max_used_connections\' max_used_connections
  mysql_status \'Threads_connected\' threads_connected

  connections_ratio=$(($max_used_connections*100/$max_connections))

  cecho &quot;MAX CONNECTIONS&quot; boldblue
  cecho &quot;Current max_connections = $max_connections&quot;
  cecho &quot;Current threads_connected = $threads_connected&quot;
  cecho &quot;Historic max_used_connections = $max_used_connections&quot;
  cechon &quot;The number of used connections is &quot;

  if [ $connections_ratio -ge 85 ]; then
    txt_color=red
    error=1
  elif [ $connections_ratio -le 10 ]; then
    txt_color=red
    error=2
  else
    txt_color=green
    error=0
  fi

  cechon &quot;$connections_ratio% &quot; $txt_color
  cecho &quot;of the configured maximum.&quot;

  if [ $error -eq 1 ]; then
    cecho &quot;You should raise max_connections&quot; $txt_color
  elif [ $error -eq 2 ]; then
    cecho &quot;You are using less than 10% of your configured max_connections.&quot; $txt_color
    cecho &quot;Lowering max_connections could help to avoid an over-allocation of memory&quot; $txt_color
    cecho &quot;See \&quot;MEMORY USAGE\&quot; section to make sure you are not over-allocating&quot; $txt_color
  else
    cecho &quot;Your max_connections variable seems to be fine.&quot; $txt_color
  fi

  unset txt_color
}

# Worker Threads
check_threads() {
  cecho &quot;WORKER THREADS&quot; boldblue

  mysql_status \'Threads_created\' threads_created1
  sleep 1
  mysql_status \'Threads_created\' threads_created2

  mysql_status \'Threads_cached\' threads_cached
  mysql_status \'Uptime\' uptime
  mysql_variable \'thread_cache_size\' thread_cache_size

  historic_threads_per_sec=$(($threads_created1/$uptime))
  current_threads_per_sec=$(($threads_created2-$threads_created1))

  cecho &quot;Current thread_cache_size = $thread_cache_size&quot;
  cecho &quot;Current threads_cached = $threads_cached&quot;
  cecho &quot;Current threads_per_sec = $current_threads_per_sec&quot;
  cecho &quot;Historic threads_per_sec = $historic_threads_per_sec&quot;

  if [ $historic_threads_per_sec -ge 2 ] &amp;&amp; [ $threads_cached -le 1 ] ; then
    cecho &quot;Threads created per/sec are overrunning threads cached&quot; red
    cecho &quot;You should raise thread_cache_size&quot; red
  elif [ $current_threads_per_sec -ge 2 ] ; then
    cecho &quot;Threads created per/sec are overrunning threads cached&quot; red
    cecho &quot;You should raise thread_cache_size&quot; red
  else
    cecho &quot;Your thread_cache_size is fine&quot; green
  fi
}

# Key buffer Size
check_key_buffer_size() {
  cecho &quot;KEY BUFFER&quot; boldblue

  mysql_status \'Key_read_requests\' key_read_requests
  mysql_status \'Key_reads\' key_reads
  mysql_status \'Key_blocks_used\' key_blocks_used
  mysql_status \'Key_blocks_unused\' key_blocks_unused
  mysql_variable \'key_cache_block_size\' key_cache_block_size
  mysql_variable \'key_buffer_size\' key_buffer_size
  mysql_variable \'datadir\' datadir
  mysql_variable \'version_compile_machine\' mysql_version_compile_machine

  myisam_indexes=$($mysql -Bse &quot;/*!50000 SELECT IFNULL(SUM(INDEX_LENGTH),0) from information_schema.TABLES where ENGINE='MyISAM' */&quot;)

  if [ -z $myisam_indexes ]; then
    myisam_indexes=$(find $datadir -name '*.MYI' -exec du $duflags '{}' \; 2&gt;&amp;1 | awk '{ s += $1 } END { printf(&quot;%.0f\n&quot;, s )}')
  fi

  if [ $key_reads -eq 0 ]; then
    cecho &quot;No key reads?!&quot; boldred
    cecho &quot;Seriously look into using some indexes&quot; red

    key_cache_miss_rate=0
    key_buffer_free=$(echo &quot;$key_blocks_unused * $key_cache_block_size / $key_buffer_size * 100&quot; | bc -l )
    key_buffer_freeRND=$(echo &quot;scale=0; $key_buffer_free / 1&quot; | bc -l)
  else
    key_cache_miss_rate=$(($key_read_requests/$key_reads))

    if [ ! -z $key_blocks_unused ] ; then
      key_buffer_free=$(echo &quot;$key_blocks_unused * $key_cache_block_size / $key_buffer_size * 100&quot; | bc -l )
      key_buffer_freeRND=$(echo &quot;scale=0; $key_buffer_free / 1&quot; | bc -l)
    else
      key_buffer_free='Unknown'
      key_buffer_freeRND=75
    fi
  fi

  human_readable $myisam_indexes myisam_indexesHR
  cecho &quot;Current MyISAM index space = $myisam_indexesHR $unit&quot; 

  human_readable  $key_buffer_size key_buffer_sizeHR
  cecho &quot;Current key_buffer_size = $key_buffer_sizeHR $unit&quot;
  cecho &quot;Key cache miss rate is 1 : $key_cache_miss_rate&quot;
  cecho &quot;Key buffer free ratio = $key_buffer_freeRND %&quot; 

  if [ &quot;$major_version&quot; = '5.1' ] &amp;&amp; [ $mysql_version_num -lt 050123 ]; then
    if [ $key_buffer_size -ge 4294967296 ] &amp;&amp; ( echo &quot;x86_64 ppc64 ia64 sparc64 i686&quot; | grep -q $mysql_version_compile_machine ) ; then
      cecho &quot;Using key_buffer_size &gt; 4GB will cause instability in versions prior to 5.1.23 &quot; boldred
      cecho &quot;See Bug#5731, Bug#29419, Bug#29446&quot; boldred
    fi
  fi

  if [ &quot;$major_version&quot; = '5.0' ] &amp;&amp; [ $mysql_version_num -lt 050052 ] ; then
    if [ $key_buffer_size -ge 4294967296 ] &amp;&amp; ( echo &quot;x86_64 ppc64 ia64 sparc64 i686&quot; | grep -q $mysql_version_compile_machine ) ; then
      cecho &quot;Using key_buffer_size &gt; 4GB will cause instability in versions prior to 5.0.52 &quot; boldred
      cecho &quot;See Bug#5731, Bug#29419, Bug#29446&quot; boldred
    fi
  fi

  if [ &quot;$major_version&quot; = '4.1' -o &quot;$major_version&quot; = '4.0' ] &amp;&amp; [ $key_buffer_size -ge 4294967296 ] &amp;&amp; ( echo &quot;x86_64 ppc64 ia64 sparc64 i686&quot; | grep -q $mysql_version_compile_machine ) ; then
    cecho &quot;Using key_buffer_size &gt; 4GB will cause instability in versions prior to 5.0.52 &quot; boldred
    cecho &quot;Reduce key_buffer_size to a safe value&quot; boldred
    cecho &quot;See Bug#5731, Bug#29419, Bug#29446&quot; boldred
  fi

  if [ $key_cache_miss_rate -le 100 ] &amp;&amp; [ $key_cache_miss_rate -gt 0 ] &amp;&amp; [ $key_buffer_freeRND -le 20 ]; then
    cecho &quot;You could increase key_buffer_size&quot; boldred
    cecho &quot;It is safe to raise this up to 1/4 of total system memory;&quot;
    cecho &quot;assuming this is a dedicated database server.&quot;
  elif [ $key_buffer_freeRND -le 20 ] &amp;&amp; [ $key_buffer_size -le $myisam_indexes ] ; then
    cecho &quot;You could increase key_buffer_size&quot; boldred
    cecho &quot;It is safe to raise this up to 1/4 of total system memory;&quot;
    cecho &quot;assuming this is a dedicated database server.&quot;
  elif [ $key_cache_miss_rate -ge 10000 ] || [ $key_buffer_freeRND -le 50  ] ; then
    cecho &quot;Your key_buffer_size seems to be too high.&quot; red 
    cecho &quot;Perhaps you can use these resources elsewhere&quot; red
  else
    cecho &quot;Your key_buffer_size seems to be fine&quot; green
  fi
}

# Query Cache
check_query_cache() {
  cecho &quot;QUERY CACHE&quot; boldblue

  mysql_variable \'version\' mysql_version
  mysql_variable \'query_cache_size\' query_cache_size
  mysql_variable \'query_cache_limit\' query_cache_limit
  mysql_variable \'query_cache_min_res_unit\' query_cache_min_res_unit
  mysql_status \'Qcache_free_memory\' qcache_free_memory
  mysql_status \'Qcache_total_blocks\' qcache_total_blocks
  mysql_status \'Qcache_free_blocks\' qcache_free_blocks
  mysql_status \'Qcache_lowmem_prunes\' qcache_lowmem_prunes

  if [ -z $query_cache_size ] ; then
    cecho &quot;You are using MySQL $mysql_version, no query cache is supported.&quot; red
    cecho &quot;I recommend an upgrade to MySQL 4.1 or better&quot; red
  elif [ $query_cache_size -eq 0 ] ; then
    cecho &quot;Query cache is supported but not enabled&quot; red
    cecho &quot;Perhaps you should set the query_cache_size&quot; red
  else
    qcache_used_memory=$(($query_cache_size-$qcache_free_memory))
    qcache_mem_fill_ratio=$(echo &quot;scale=2; $qcache_used_memory * 100 / $query_cache_size&quot; | bc -l)
    qcache_mem_fill_ratioHR=$(echo &quot;scale=0; $qcache_mem_fill_ratio / 1&quot; | bc -l)

    cecho &quot;Query cache is enabled&quot; green
    human_readable $query_cache_size query_cache_sizeHR
    cecho &quot;Current query_cache_size = $query_cache_sizeHR $unit&quot;
    human_readable $qcache_used_memory qcache_used_memoryHR
    cecho &quot;Current query_cache_used = $qcache_used_memoryHR $unit&quot;
    human_readable $query_cache_limit query_cache_limitHR
    cecho &quot;Current query_cache_limit = $query_cache_limitHR $unit&quot;
    cecho &quot;Current Query cache Memory fill ratio = $qcache_mem_fill_ratio %&quot;

    if [ -z $query_cache_min_res_unit ] ; then
      cecho &quot;No query_cache_min_res_unit is defined.  Using MySQL &lt; 4.1 cache fragmentation can be inpredictable&quot; %yellow
    else
      human_readable $query_cache_min_res_unit query_cache_min_res_unitHR 
      cecho &quot;Current query_cache_min_res_unit = $query_cache_min_res_unitHR $unit&quot;
    fi

    if [ $qcache_free_blocks -gt 2 ] &amp;&amp; [ $qcache_total_blocks -gt 0 ]; then
      qcache_percent_fragmented=$(echo &quot;scale=2; $qcache_free_blocks * 100 / $qcache_total_blocks&quot; | bc -l)
      qcache_percent_fragmentedHR=$(echo &quot;scale=0; $qcache_percent_fragmented / 1&quot; | bc -l)

      if [ $qcache_percent_fragmentedHR -gt 20 ] ; then
        cecho &quot;Query Cache is $qcache_percent_fragmentedHR % fragmented&quot; red
        cecho &quot;Run \&quot;FLUSH QUERY CACHE\&quot; periodically to defragment the query cache memory&quot; red 
        cecho &quot;If you have many small queries lower 'query_cache_min_res_unit' to reduce fragmentation.&quot; red
      fi
    fi

    if [ $qcache_mem_fill_ratioHR -le 25 ]; then
      cecho &quot;Your query_cache_size seems to be too high.&quot; red
      cecho &quot;Perhaps you can use these resources elsewhere&quot; red
    fi

    if [ $qcache_lowmem_prunes -ge 50 ] &amp;&amp; [ $qcache_mem_fill_ratioHR -ge 80 ]; then
      cechon &quot;However, &quot;
      cechon &quot;$qcache_lowmem_prunes &quot; boldred
      cecho &quot;queries have been removed from the query cache due to lack of memory&quot;
      cecho &quot;Perhaps you should raise query_cache_size&quot; boldred
    fi

    cecho &quot;MySQL won't cache query results that are larger than query_cache_limit in size&quot; yellow
  fi
}

# Sort Operations
check_sort_operations() {
  cecho &quot;SORT OPERATIONS&quot; boldblue

  mysql_status \'Sort_merge_passes\' sort_merge_passes
  mysql_status \'Sort_scan\' sort_scan
  mysql_status \'Sort_range\' sort_range
  mysql_variable \'sort_buffer%\' sort_buffer_size 
  mysql_variable \'read_rnd_buffer_size\' read_rnd_buffer_size 

  total_sorts=$(($sort_scan+$sort_range))
  if [ -z $read_rnd_buffer_size ]; then
    mysql_variable \'record_buffer\' read_rnd_buffer_size
  fi

  ## Correct for rounding error in mysqld where 512K != 524288 ##
  sort_buffer_size=$(($sort_buffer_size+8))
  read_rnd_buffer_size=$(($read_rnd_buffer_size+8))

  human_readable $sort_buffer_size sort_buffer_sizeHR
  cecho &quot;Current sort_buffer_size = $sort_buffer_sizeHR $unit&quot;

  human_readable $read_rnd_buffer_size read_rnd_buffer_sizeHR
  cechon &quot;Current &quot;

  if [ &quot;$major_version&quot; = '3.23' ]; then
    cechon &quot;record_rnd_buffer &quot;
  else
    cechon &quot;read_rnd_buffer_size &quot;
  fi

  cecho &quot;= $read_rnd_buffer_sizeHR $unit&quot;
  if [ $total_sorts -eq 0 ] ; then
    cecho &quot;No sort operations have been performed&quot;
    passes_per_sort=0
  fi

  if [ $sort_merge_passes -ne 0 ]; then
    passes_per_sort=$(($sort_merge_passes/$total_sorts))
  else
    passes_per_sort=0
  fi

  if [ $passes_per_sort -ge 2 ]; then
    cechon &quot;On average &quot;
    cechon &quot;$passes_per_sort &quot; boldred
    cecho &quot;sort merge passes are made per sort operation&quot;
    cecho &quot;You should raise your sort_buffer_size&quot;
    cechon &quot;You should also raise your &quot;

    if [ &quot;$major_version&quot; = '3.23' ]; then
      cecho &quot;record_rnd_buffer_size&quot;
    else
      cecho &quot;read_rnd_buffer_size&quot;
    fi
  else
    cecho &quot;Sort buffer seems to be fine&quot; green
  fi
}

# Joins
check_join_operations() {
  cecho &quot;JOINS&quot; boldblue

  mysql_status \'Select_full_join\' select_full_join
  mysql_status \'Select_range_check\' select_range_check
  mysql_variable \'join_buffer%\' join_buffer_size

  # Some 4K is dropped from join_buffer_size adding it back to make sane
  # handling of human-readable conversion

  join_buffer_size=$(($join_buffer_size+4096))
  human_readable $join_buffer_size join_buffer_sizeHR 2

  cecho &quot;Current join_buffer_size = $join_buffer_sizeHR $unit&quot;
  cecho &quot;You have had $select_full_join queries where a join could not use an index properly&quot;

  if [ $select_range_check -eq 0 ] &amp;&amp; [ $select_full_join -eq 0 ]; then
    cecho &quot;Your joins seem to be using indexes properly&quot; green
  fi

  if [ $select_full_join -gt 0 ]; then
    print_error='true'
    raise_buffer='true'
  fi

  if [ $select_range_check -gt 0 ]; then
    cecho &quot;You have had $select_range_check joins without keys that check for key usage after each row&quot; red
    print_error='true'
    raise_buffer='true'
  fi

  if [ $join_buffer_size -ge 4194304 ]; then
    cecho &quot;join_buffer_size &gt;= 4 M&quot; boldred
    cecho &quot;This is not advised&quot; boldred
    raise_buffer=
  fi

  if [ $print_error ]; then
    if [ &quot;$major_version&quot; = '3.23' ] || [ &quot;$major_version&quot; = '4.0' ]; then
      cecho &quot;You should enable \&quot;log-long-format\&quot; &quot;
    elif [ &quot;$mysql_version_num&quot; -gt 040100 ]; then
      cecho &quot;You should enable \&quot;log-queries-not-using-indexes\&quot;&quot;
    fi

    cecho &quot;Then look for non indexed joins in the slow query log.&quot;
    if [ $raise_buffer ]; then
      cecho &quot;If you are unable to optimize your queries you may want to increase your&quot;
      cecho &quot;join_buffer_size to accommodate larger joins in one pass.&quot;
      printf &quot;\n&quot;
      cecho &quot;Note! This script will still suggest raising the join_buffer_size when&quot; boldred
      cecho &quot;ANY joins not using indexes are found.&quot; boldred
    fi
  fi
}

# Temp Tables
check_tmp_tables() {
  cecho &quot;TEMP TABLES&quot; boldblue

  mysql_status \'Created_tmp_tables\' created_tmp_tables 
  mysql_status \'Created_tmp_disk_tables\' created_tmp_disk_tables
  mysql_variable \'tmp_table_size\' tmp_table_size
  mysql_variable \'max_heap_table_size\' max_heap_table_size

  if [ $created_tmp_tables -eq 0 ]; then
    tmp_disk_tables=0
  else
    tmp_disk_tables=$((created_tmp_disk_tables*100/(created_tmp_tables+created_tmp_disk_tables)))
  fi

  human_readable $max_heap_table_size max_heap_table_sizeHR
  cecho &quot;Current max_heap_table_size = $max_heap_table_sizeHR $unit&quot;

  human_readable $tmp_table_size tmp_table_sizeHR 
  cecho &quot;Current tmp_table_size = $tmp_table_sizeHR $unit&quot;

  cecho &quot;Of $created_tmp_tables temp tables, $tmp_disk_tables% were created on disk&quot;
  if [ $tmp_table_size -gt $max_heap_table_size ]; then
    cecho &quot;Effective in-memory tmp_table_size is limited to max_heap_table_size.&quot; yellow
  fi

  if [ $tmp_disk_tables -ge 25 ]; then
    cecho &quot;Perhaps you should increase your tmp_table_size and/or max_heap_table_size&quot; boldred
    cecho &quot;to reduce the number of disk-based temporary tables&quot; boldred
    cecho &quot;Note! BLOB and TEXT columns are not allow in memory tables.&quot; yellow
    cecho &quot;If you are using these columns raising these values might not impact your &quot; yellow
    cecho  &quot;ratio of on disk temp tables.&quot; yellow
  else
    cecho &quot;Created disk tmp tables ratio seems fine&quot; green
  fi
}

# Open Files Limit
check_open_files() {
  cecho &quot;OPEN FILES LIMIT&quot; boldblue

  mysql_variable \'open_files_limit\' open_files_limit
  mysql_status   \'Open_files\' open_files

  if [ -z $open_files_limit ] || [ $open_files_limit -eq 0 ]; then
    open_files_limit=$(ulimit -n)
    cant_override=1
  else
    cant_override=0
  fi

  cecho &quot;Current open_files_limit = $open_files_limit files&quot;

  open_files_ratio=$(($open_files*100/$open_files_limit))

  cecho &quot;The open_files_limit should typically be set to at least 2x-3x&quot; yellow
  cecho &quot;that of table_cache if you have heavy MyISAM usage.&quot; yellow
  if [ $open_files_ratio -ge 75 ]; then
    cecho &quot;You currently have open more than 75% of your open_files_limit&quot; boldred

    if [ $cant_override -eq 1 ]; then
      cecho &quot;You should set a higer value for ulimit -u in the mysql startup script then restart mysqld&quot; boldred
      cecho &quot;MySQL 3.23 users : This is just a guess based upon the current shell's ulimit -u value&quot; yellow
    elif [ $cant_override -eq 0 ]; then
      cecho &quot;You should set a higher value for open_files_limit in my.cnf&quot; boldred
    else
      cecho &quot;ERROR can't determine if mysqld override of ulimit is allowed&quot; boldred
      exit 1
    fi
  else
    cecho &quot;Your open_files_limit value seems to be fine&quot; green
  fi
}

# Table Cache
check_table_cache() {
  cecho &quot;TABLE CACHE&quot; boldblue

  mysql_variable \'datadir\' datadir
  mysql_variable \'table_cache\' table_cache

  # MySQL +5.1 version of table_cache
  mysql_variable \'table_open_cache\' table_open_cache
  mysql_variable \'table_definition_cache\' table_definition_cache

  mysql_status \'Open_tables\' open_tables
  mysql_status \'Opened_tables\' opened_tables
  mysql_status \'Open_table_definitions\' open_table_definitions

  table_count=$($mysql -Bse &quot;/*!50000 SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE' */&quot;)

  if [ -z &quot;$table_count&quot; ]; then
    if [ &quot;$UID&quot; != &quot;$socket_owner&quot; ] &amp;&amp; [ &quot;$UID&quot; != &quot;0&quot; ] ; then
      cecho &quot;You are not '$socket_owner' or 'root'&quot; red
      cecho &quot;I am unable to determine the table_count!&quot; red
    else
      table_count=$(find $datadir 2&gt;&amp;1 | grep -c .frm$)
    fi
  fi

  if [ $table_open_cache ]; then
    table_cache=$table_open_cache
  fi

  if [ $opened_tables -ne 0 ] &amp;&amp; [ $table_cache -ne 0 ]; then
    table_cache_hit_rate=$(($open_tables*100/$opened_tables))
    table_cache_fill=$(($open_tables*100/$table_cache))
  elif [ $opened_tables -eq 0 ] &amp;&amp; [ $table_cache -ne 0 ]; then
    table_cache_hit_rate=100
    table_cache_fill=$(($open_tables*100/$table_cache))
  else
    cecho &quot;ERROR no table_cache ?!&quot; boldred
    exit 1
  fi

  if [ $table_cache ] &amp;&amp; [ ! $table_open_cache ]; then
    cecho &quot;Current table_cache value = $table_cache tables&quot;
  fi

  if [ $table_open_cache ]; then
    cecho &quot;Current table_open_cache = $table_open_cache tables&quot;
    cecho &quot;Current table_definition_cache = $table_definition_cache tables&quot;
  fi

  if [ $table_count ]; then
    cecho &quot;You have a total of $table_count tables&quot;
  fi

  if  [ $table_cache_fill -lt 95 ]; then
    cechon &quot;You have &quot;
    cechon &quot;$open_tables &quot; green
    cecho &quot;open tables.&quot; 
    cecho &quot;The table_cache value seems to be fine&quot; green
  elif [ $table_cache_hit_rate -le 85 -o  $table_cache_fill -ge 95 ]; then
    cechon &quot;You have &quot;
    cechon &quot;$open_tables &quot; boldred
    cecho &quot;open tables.&quot;
    cechon &quot;Current table_cache hit rate is &quot; 
    cecho &quot;$table_cache_hit_rate%&quot; boldred
    cechon &quot;, while &quot;
    cechon &quot;$table_cache_fill% &quot; boldred
    cecho &quot;of your table cache is in use&quot;
    cecho &quot;You should probably increase your table_cache&quot; red
  else
    cechon &quot;Current table_cache hit rate is &quot;
    cechon &quot;$table_cache_hit_rate%&quot; green
    cechon &quot;, while &quot;
    cechon &quot;$table_cache_fill% &quot; green
    cecho &quot;of your table cache is in use&quot;
    cecho &quot;The table cache value seems to be fine&quot; green
  fi

  if [ $table_definition_cache ] &amp;&amp; [ $table_definition_cache -le $table_count ] &amp;&amp; [ $table_count -ge 100 ]; then
    cecho &quot;You should probably increase your table_definition_cache value.&quot; red
  fi
}

# Table Locking
check_table_locking() {
  cecho &quot;TABLE LOCKING&quot; boldblue

  mysql_status \'Table_locks_waited\' table_locks_waited
  mysql_status \'Table_locks_immediate\' table_locks_immediate
  mysql_variable \'concurrent_insert\' concurrent_insert
  mysql_variable \'low_priority_updates\' low_priority_updates

  if [ &quot;$concurrent_insert&quot; = 'ON' ]; then
    concurrent_insert=1
  elif [ &quot;$concurrent_insert&quot; = 'OFF' ]; then
    concurrent_insert=0
  fi

  cechon &quot;Current Lock Wait ratio = &quot;
  if [ $table_locks_waited -gt 0 ]; then
    immediate_locks_miss_rate=$(($table_locks_immediate/$table_locks_waited))
    cecho &quot;1 : $immediate_locks_miss_rate&quot; red
  else
    immediate_locks_miss_rate=99999 # perfect
    cecho &quot;0 : $questions&quot;
  fi

  if [ $immediate_locks_miss_rate -lt 5000 ]; then
    cecho &quot;You may benefit from selective use of InnoDB.&quot;

    if [ &quot;$low_priority_updates&quot; = 'OFF' ]; then
      cecho &quot;If you have long running SELECT's against MyISAM tables and perform&quot;
      cecho &quot;frequent updates consider setting 'low_priority_updates=1'&quot;
    fi

    if [ &quot;$mysql_version_num&quot; -gt 050000 ] &amp;&amp; [ &quot;$mysql_version_num&quot; -lt 050500 ]; then
      if [ $concurrent_insert -le 1 ]; then
        cecho &quot;If you have a high concurrency of inserts on Dynamic row-length tables&quot;
        cecho &quot;consider setting 'concurrent_insert=2'.&quot;
      fi
    elif [ &quot;$mysql_version_num&quot; -gt 050500 ]; then
      if [ &quot;$concurrent_insert&quot; = 'AUTO' ] || [ &quot;$concurrent_insert&quot; = 'NEVER' ]; then
        cecho &quot;If you have a high concurrency of inserts on Dynamic row-length tables&quot;
        cecho &quot;consider setting 'concurrent_insert=ALWAYS'.&quot;
      fi
    fi
  else
    cecho &quot;Your table locking seems to be fine&quot; green
  fi
}

# Table Scans
check_table_scans() {
  cecho &quot;TABLE SCANS&quot; boldblue

  mysql_status \'Com_select\' com_select
  mysql_status \'Handler_read_rnd_next\' read_rnd_next
  mysql_variable \'read_buffer_size\' read_buffer_size

  if [ -z $read_buffer_size ]; then
    mysql_variable \'record_buffer\' read_buffer_size
  fi

  human_readable $read_buffer_size read_buffer_sizeHR
  cecho &quot;Current read_buffer_size = $read_buffer_sizeHR $unit&quot;

  if [ $com_select -gt 0 ]; then
    full_table_scans=$(($read_rnd_next/$com_select))

    cecho &quot;Current table scan ratio = $full_table_scans : 1&quot;
    if [ $full_table_scans -ge 4000 ] &amp;&amp; [ $read_buffer_size -le 2097152 ]; then
      cecho &quot;You have a high ratio of sequential access requests to SELECTs&quot; red
      cechon &quot;You may benefit from raising &quot; red

      if [ &quot;$major_version&quot; = '3.23' ] ; then
        cechon &quot;record_buffer &quot; red
      else
        cechon &quot;read_buffer_size &quot; red
      fi

      cecho &quot;and/or improving your use of indexes.&quot; red
    elif [ $read_buffer_size -gt 8388608 ] ; then
      cechon &quot;read_buffer_size is over 8 MB &quot; red
      cecho &quot;there is probably no need for such a large read_buffer&quot; red
    else
      cecho &quot;read_buffer_size seems to be fine&quot; green
    fi
  else
    cecho &quot;read_buffer_size seems to be fine&quot; green
  fi
}

# InnoDB
check_innodb_status () {
  ## See http://bugs.mysql.com/59393

  if [ &quot;$mysql_version_num&quot; -lt 050603 ]; then
    mysql_variable \'have_innodb\' have_innodb
  fi

  if [ &quot;$mysql_version_num&quot; -lt 050500 ] &amp;&amp; [ &quot;$have_innodb&quot; = &quot;YES&quot; ]; then
    innodb_enabled=1
  fi

  if [ &quot;$mysql_version_num&quot; -ge 050500 ] &amp;&amp; [ &quot;$mysql_version_num&quot; -lt 050512 ]; then
    mysql_variable \'ignore_builtin_innodb\' ignore_builtin_innodb

    if [ &quot;$ignore_builtin_innodb&quot; = &quot;ON&quot; ] || [ $have_innodb = &quot;NO&quot; ]; then
      innodb_enabled=0
    else
      innodb_enabled=1
    fi
  elif [ &quot;$major_version&quot;  = '5.5' ] &amp;&amp; [ &quot;$mysql_version_num&quot; -ge 050512 ]; then
    mysql_variable \'ignore_builtin_innodb\' ignore_builtin_innodb
    if [ &quot;$ignore_builtin_innodb&quot; = &quot;ON&quot; ]; then
      innodb_enabled=0
    else
      innodb_enabled=1
    fi
  elif [ &quot;$mysql_version_num&quot; -ge 050600 ] &amp;&amp; [ &quot;$mysql_version_num&quot; -lt 050603 ]; then
    mysql_variable \'ignore_builtin_innodb\' ignore_builtin_innodb

    if [ &quot;$ignore_builtin_innodb&quot; = &quot;ON&quot; ] || [ $have_innodb = &quot;NO&quot; ]; then
      innodb_enabled=0
    else
      innodb_enabled=1
    fi
  elif [ &quot;$major_version&quot; = '5.6' ] &amp;&amp; [ &quot;$mysql_version_num&quot; -ge 050603 ]; then
    mysql_variable \'ignore_builtin_innodb\' ignore_builtin_innodb

    if [ &quot;$ignore_builtin_innodb&quot; = &quot;ON&quot; ]; then
      innodb_enabled=0
    else
      innodb_enabled=1
    fi
  fi
  if [ &quot;$innodb_enabled&quot; = 1 ]; then
    mysql_variable \'innodb_buffer_pool_size\' innodb_buffer_pool_size
    mysql_variable \'innodb_additional_mem_pool_size\' innodb_additional_mem_pool_size
    mysql_variable \'innodb_fast_shutdown\' innodb_fast_shutdown
    mysql_variable \'innodb_flush_log_at_trx_commit\' innodb_flush_log_at_trx_commit
    mysql_variable \'innodb_locks_unsafe_for_binlog\' innodb_locks_unsafe_for_binlog
    mysql_variable \'innodb_log_buffer_size\' innodb_log_buffer_size
    mysql_variable \'innodb_log_file_size\' innodb_log_file_size
    mysql_variable \'innodb_log_files_in_group\' innodb_log_files_in_group
    mysql_variable \'innodb_safe_binlog\' innodb_safe_binlog
    mysql_variable \'innodb_thread_concurrency\' innodb_thread_concurrency

    cecho &quot;INNODB STATUS&quot; boldblue
    innodb_indexes=$($mysql -Bse &quot;/*!50000 SELECT IFNULL(SUM(INDEX_LENGTH),0) from information_schema.TABLES where ENGINE='InnoDB' */&quot;)
    innodb_data=$($mysql -Bse &quot;/*!50000 SELECT IFNULL(SUM(DATA_LENGTH),0) from information_schema.TABLES where ENGINE='InnoDB' */&quot;)

    if [ ! -z &quot;$innodb_indexes&quot; ]; then
      mysql_status \'Innodb_buffer_pool_pages_data\' innodb_buffer_pool_pages_data
      mysql_status \'Innodb_buffer_pool_pages_misc\' innodb_buffer_pool_pages_misc
      mysql_status \'Innodb_buffer_pool_pages_free\' innodb_buffer_pool_pages_free
      mysql_status \'Innodb_buffer_pool_pages_total\' innodb_buffer_pool_pages_total

      mysql_status \'Innodb_buffer_pool_read_ahead_seq\' innodb_buffer_pool_read_ahead_seq
      mysql_status \'Innodb_buffer_pool_read_requests\' innodb_buffer_pool_read_requests

      mysql_status \'Innodb_os_log_pending_fsyncs\' innodb_os_log_pending_fsyncs
      mysql_status \'Innodb_os_log_pending_writes\' innodb_os_log_pending_writes
      mysql_status \'Innodb_log_waits\' innodb_log_waits

      mysql_status \'Innodb_row_lock_time\' innodb_row_lock_time
      mysql_status \'Innodb_row_lock_waits\' innodb_row_lock_waits

      human_readable $innodb_indexes innodb_indexesHR
      cecho &quot;Current InnoDB index space = $innodb_indexesHR $unit&quot;
      human_readable $innodb_data innodb_dataHR
      cecho &quot;Current InnoDB data space = $innodb_dataHR $unit&quot;
      percent_innodb_buffer_pool_free=$(($innodb_buffer_pool_pages_free*100/$innodb_buffer_pool_pages_total))
      cecho &quot;Current InnoDB buffer pool free = &quot;$percent_innodb_buffer_pool_free&quot; %&quot;
    else
      cecho &quot;Cannot parse InnoDB stats prior to 5.0.x&quot; red
      $mysql -s -e &quot;SHOW /*!50000 ENGINE */ INNODB STATUS\G&quot;
    fi

    human_readable $innodb_buffer_pool_size innodb_buffer_pool_sizeHR
    cecho &quot;Current innodb_buffer_pool_size = $innodb_buffer_pool_sizeHR $unit&quot;
    cecho &quot;Depending on how much space your innodb indexes take up it may be safe&quot;
    cecho &quot;to increase this value to up to 2 / 3 of total system memory&quot;
  else
    cecho &quot;No InnoDB Support Enabled!&quot; boldred
  fi
}

# Total Memory Usage
total_memory_used() {
  cecho &quot;MEMORY USAGE&quot; boldblue

  mysql_variable \'read_buffer_size\' read_buffer_size
  mysql_variable \'read_rnd_buffer_size\' read_rnd_buffer_size
  mysql_variable \'sort_buffer_size\' sort_buffer_size
  mysql_variable \'thread_stack\' thread_stack
  mysql_variable \'max_connections\' max_connections
  mysql_variable \'join_buffer_size\' join_buffer_size
  mysql_variable \'tmp_table_size\' tmp_table_size
  mysql_variable \'max_heap_table_size\' max_heap_table_size
  mysql_variable \'log_bin\' log_bin
  mysql_status \'Max_used_connections\' max_used_connections

  if [ &quot;$major_version&quot; = &quot;3.23&quot; ]; then
    mysql_variable \'record_buffer\' read_buffer_size
    mysql_variable \'record_rnd_buffer\' read_rnd_buffer_size
    mysql_variable \'sort_buffer\' sort_buffer_size
  fi

  if [ &quot;$log_bin&quot; = &quot;ON&quot; ]; then
    mysql_variable \'binlog_cache_size\' binlog_cache_size
  else
    binlog_cache_size=0
  fi

  if [ $max_heap_table_size -le $tmp_table_size ]; then
    effective_tmp_table_size=$max_heap_table_size
  else
    effective_tmp_table_size=$tmp_table_size
  fi

  per_thread_buffers=$(echo &quot;($read_buffer_size+$read_rnd_buffer_size+$sort_buffer_size+$thread_stack+$join_buffer_size+$binlog_cache_size)*$max_connections&quot; | bc -l)
  per_thread_max_buffers=$(echo &quot;($read_buffer_size+$read_rnd_buffer_size+$sort_buffer_size+$thread_stack+$join_buffer_size+$binlog_cache_size)*$max_used_connections&quot; | bc -l)

  mysql_variable \'innodb_buffer_pool_size\' innodb_buffer_pool_size
  if [ -z $innodb_buffer_pool_size ]; then
    innodb_buffer_pool_size=0
  fi

  mysql_variable \'innodb_additional_mem_pool_size\' innodb_additional_mem_pool_size
  if [ -z $innodb_additional_mem_pool_size ]; then
    innodb_additional_mem_pool_size=0
  fi

  mysql_variable \'innodb_log_buffer_size\' innodb_log_buffer_size
  if [ -z $innodb_log_buffer_size ]; then
    innodb_log_buffer_size=0
  fi

  mysql_variable \'key_buffer_size\' key_buffer_size
  mysql_variable \'query_cache_size\' query_cache_size
  if [ -z $query_cache_size ]; then
    query_cache_size=0
  fi

  global_buffers=$(echo &quot;$innodb_buffer_pool_size+$innodb_additional_mem_pool_size+$innodb_log_buffer_size+$key_buffer_size+$query_cache_size&quot; | bc -l)

  max_memory=$(echo &quot;$global_buffers+$per_thread_max_buffers&quot; | bc -l)
  total_memory=$(echo &quot;$global_buffers+$per_thread_buffers&quot; | bc -l)

  pct_of_sys_mem=$(echo &quot;scale=0; $total_memory*100/$physical_memory&quot; | bc -l)

  if [ $pct_of_sys_mem -gt 90 ]; then
    txt_color=boldred
    error=1
  else
    txt_color=
    error=0
  fi

  human_readable $max_memory max_memoryHR
  cecho &quot;Max Memory Ever Allocated : $max_memoryHR $unit&quot; $txt_color

  human_readable $per_thread_buffers per_thread_buffersHR
  cecho &quot;Configured Max Per-thread Buffers : $per_thread_buffersHR $unit&quot; $txt_color

  human_readable $global_buffers global_buffersHR
  cecho &quot;Configured Max Global Buffers : $global_buffersHR $unit&quot; $txt_color

  human_readable $total_memory total_memoryHR
  cecho &quot;Configured Max Memory Limit : $total_memoryHR $unit&quot; $txt_color

  human_readable $physical_memory physical_memoryHR
  cecho &quot;Physical Memory : $physical_memoryHR $unit&quot; $txt_color

  if [ $error -eq 1 ]; then
    printf &quot;\n&quot;
    cecho &quot;Max memory limit exceeds 90% of physical memory&quot; $txt_color
  else
    cecho &quot;Max memory limit seem to be within acceptable norms&quot; green
  fi
  unset txt_color
}

# Required Functions
login_validation() {
  check_for_socket          # determine the socket location -- 1st login
  check_for_plesk_passwords # determine the login method -- 2nd login
  check_mysql_login         # determine if mysql is accepting login -- 3rd login
  export major_version=$($mysql -Bse &quot;SELECT SUBSTRING_INDEX(VERSION(), '.', +2)&quot;)
  export mysql_version_num=$($mysql -Bse &quot;SELECT VERSION()&quot; |
    awk -F \. '{ printf &quot;%02d&quot;, $1; printf &quot;%02d&quot;, $2; printf &quot;%02d&quot;, $3 }')
}

shared_info() {
  export major_version=$($mysql -Bse &quot;SELECT SUBSTRING_INDEX(VERSION(), '.', +2)&quot;)
  export mysql_version_num=$($mysql -Bse &quot;SELECT VERSION()&quot; |
    awk -F \. '{ printf &quot;%02d&quot;, $1; printf &quot;%02d&quot;, $2; printf &quot;%02d&quot;, $3 }')
  mysql_status \'Questions\' questions
  socket_owner=$(ls -nH $socket | awk '{ print $3 }')
}

get_system_info() {
  export OS=$(uname)

  # Get information for various UNIXes
  if [ &quot;$OS&quot; = 'Darwin' ]; then
    ps_socket=$(netstat -ln | awk '/mysql(.*)?\.sock/ { print $9 }' | head -1)
    found_socks=$(netstat -ln | awk '/mysql(.*)?\.sock/ { print $9 }')
    export physical_memory=$(sysctl -n hw.memsize)
    export duflags=''
  elif [ &quot;$OS&quot; = 'FreeBSD' ] || [ &quot;$OS&quot; = 'OpenBSD' ]; then
    ## On FreeBSD must be root to locate sockets.
    ps_socket=$(netstat -ln | awk '/mysql(.*)?\.sock/ { print $9 }' | head -1)
    found_socks=$(netstat -ln | awk '/mysql(.*)?\.sock/ { print $9 }')
    export physical_memory=$(sysctl -n hw.realmem)
    export duflags=''
  elif [ &quot;$OS&quot; = 'Linux' ]; then
    ## Includes SWAP
    ## export physical_memory=$(free -b | grep -v buffers |  awk '{ s += $2 } END { printf(&quot;%.0f\n&quot;, s ) }')
    ps_socket=$(netstat -ln | awk '/mysql(.*)?\.sock/ { print $9 }' | head -1)
    found_socks=$(netstat -ln | awk '/mysql(.*)?\.sock/ { print $9 }')
    export physical_memory=$(awk '/^MemTotal/ { printf(&quot;%.0f&quot;, $2*1024 ) }' &lt; /proc/meminfo)
    export duflags='-b'
  elif [ &quot;$OS&quot; = 'SunOS' ]; then
    ps_socket=$(netstat -an | awk '/mysql(.*)?.sock/ { print $5 }' | head -1)
    found_socks=$(netstat -an | awk '/mysql(.*)?.sock/ { print $5 }')
    export physical_memory=$(prtconf | awk '/^Memory\ size:/ { print $3*1048576 }')
  fi

  if [ -z $(which bc) ]; then
    echo &quot;Error: Command line calculator 'bc' not found!&quot;
    exit
  fi
}

## Optional Components Groups
banner_info() {
  shared_info
  print_banner; echo
  check_mysql_version; echo
  post_uptime_warning; echo
}

misc() {
  shared_info
  check_slow_queries; echo
  check_binary_log; echo
  check_threads; echo
  check_used_connections; echo
  check_innodb_status; echo
}

memory() {
  shared_info
  total_memory_used; echo
  check_key_buffer_size; echo
  check_query_cache; echo
  check_sort_operations; echo
  check_join_operations; echo
}

file() {
  shared_info
  check_open_files; echo
  check_table_cache; echo
  check_tmp_tables; echo
  check_table_scans; echo
  check_table_locking; echo
}

all() {
  banner_info
  misc
  memory
  file
}

prompt() {
  prompted='true'
  read -p &quot;Username [anonymous] : &quot; user
  read -rp &quot;Password [&lt;none&gt;] : &quot; pass
  cecho &quot; &quot;
  read -p &quot;Socket [ /var/lib/mysql/mysql.sock ] : &quot; socket

  if [ -z $socket ]; then
    export socket='/var/lib/mysql/mysql.sock'
  fi

  if [ -z $pass ]; then
    export mysql=&quot;mysql -S $socket -u$user&quot;
    export mysqladmin=&quot;mysqladmin -S $socket -u$user&quot;
  else
    export mysql=&quot;mysql -S $socket -u$user -p$pass&quot;
    export mysqladmin=&quot;mysqladmin -S $socket -u$user -p$pass&quot;
  fi

  check_for_socket
  check_mysql_login

  if [ $? = 1 ]; then
    exit 1
  fi

  read -p &quot;Mode to test - banner, file, misc, mem, innodb, [all] : &quot; REPLY

  if [ -z $REPLY ]; then
    REPLY='all'
  fi

  case $REPLY in
    banner|BANNER|header|HEADER|head|HEAD)
      banner_info
      ;;
    misc|MISC|miscelaneous)
      misc
      ;;
    mem|memory|MEM|MEMORY)
      memory
      ;;
    file|FILE|disk|DISK)
      file
      ;;
    innodb|INNODB)
      innodb
      ;;
    all|ALL)
      cecho &quot; &quot;
      all
      ;;
    *)
      cecho &quot;Invalid Mode!  Valid options are 'banner', 'misc', 'memory', 'file', 'innodb' or 'all'&quot; boldred
      exit 1
      ;;
  esac
}

# Address environmental differences
get_system_info

if [ -z &quot;$1&quot; ]; then
  login_validation
  mode='ALL'
elif [ &quot;$1&quot; = &quot;prompt&quot; ] || [ &quot;$1&quot; = &quot;PROMPT&quot; ]; then
  mode=$1
elif [ &quot;$1&quot; != &quot;prompt&quot; ] || [ &quot;$1&quot; != &quot;PROMPT&quot; ]; then
  login_validation
  mode=$1
fi

case $mode in
  all|ALL)
    cecho &quot; &quot;
    all
    ;;
  mem|memory|MEM|MEMORY)
    cecho &quot; &quot;
    memory
    ;;
  file|FILE|disk|DISK)
    cecho &quot; &quot;
    file
    ;;
  banner|BANNER|header|HEADER|head|HEAD)
    banner_info
    ;;
  misc|MISC|miscelaneous)
    cecho &quot; &quot;
    misc
    ;;
  innodb|INNOD )
    banner_info
    check_innodb_status; echo
    ;;
  prompt|PROMPT)
    prompt
    ;;
  *)
    cecho &quot;usage: $0 [ all | banner | file | innodb | memory | misc | prompt ]&quot; boldred
    exit 1
    ;;
esac
</pre></div>
</div>

    </div>
  </body>
</html>
