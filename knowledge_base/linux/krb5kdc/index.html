<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Kerberos - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Kerberos" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/krb5kdc/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Kerberos</h1>

<p>Kerberos is a network authentication system.</p>

<h2>Installation</h2>

<p>The servers require the following packages be installed:</p>

<ul>
<li>krb5-libs</li>
<li>krb5-server</li>
<li>krb5-workstation</li>
</ul>

<p>It is very important that <a href="../ntpdate/">NTPdate</a> is already configured and running on all
of the client systems as well as the server. Kerberos is heavily dependant on
synchronized clocks.</p>

<h2>Master Configuration</h2>

<p>Edit the configuration files (provided at the bottom).</p>

<p>Create the initial database for the realm, it will ask for a master password
for the database. DO NOT FORGET THIS!!</p>
<div class="CodeRay">
  <div class="code"><pre>kdb5_util create -s
</pre></div>
</div>

<p>Create an administrator user, it will ask for the password ensure that it is
strong as this account will be able to create, delete, and see principal&#39;s
keys.</p>
<div class="CodeRay">
  <div class="code"><pre>kadmin.local -q &quot;addprinc &lt;&lt;username&gt;&gt;/admin&quot;
</pre></div>
</div>

<p>Set the services to startup automatically and start them up:</p>
<div class="CodeRay">
  <div class="code"><pre>chkconfig krb5kdc on
chkconfig kadmin on
/etc/init.d/krb5kdc start
/etc/init.d/kadmin start
</pre></div>
</div>

<p>After the database has been started you&#39;ll need to create at least one normal
user, it will ask for a password for the account.</p>
<div class="CodeRay">
  <div class="code"><pre>[root@localhost ~]# kadmin -p &lt;&lt;username&gt;&gt;/admin
kadmin:  addprinc &lt;&lt;username&gt;&gt;
</pre></div>
</div>

<h3>Slave</h3>

<p>Please note these instructions are untested but they are believed to be
correct.</p>

<p>First we&#39;ll need to create an ACL file for the replication utility <code>kprop</code>. It
should live <code>/var/Kerberos/krb5kdc/kpropd.acl</code> and have the contents:</p>
<div class="CodeRay">
  <div class="code"><pre>host/kdc1.home.bedroomprogrammers.net@BEDROOMPROGRAMMERS.NET
host/kdc2.home.bedroomprogrammers.net@BEDROOMPROGRAMMERS.NET
</pre></div>
</div>

<p>You&#39;ll need to create host keys for each of the kerberos servers if they
haven&#39;t been created already.</p>
<div class="CodeRay">
  <div class="code"><pre>[root@localhost ~]# kadmin -p &lt;&lt;username&gt;&gt;/admin
kadmin:  addprinc -rand host/kdc1.home.bedroomprogrammers.net
kadmin:  addprinc -rand host/kdc2.home.bedroomprogrammers.net
</pre></div>
</div>

<p>You&#39;ll need to add the keys to the local keytab file on the primary KDC.</p>
<div class="CodeRay">
  <div class="code"><pre>[root@localhost ~]# kadmin -p &lt;&lt;username&gt;&gt;/admin
kadmin:  ktadd host/kdc1.home.bedroomprogrammers.net
kadmin:  ktadd host/kdc2.home.bedroomprogrammers.net
</pre></div>
</div>

<p>Copy the keytab file from the primary KDC to the secondary server using an
encrypted transfer mechanism such as SCP.</p>
<div class="CodeRay">
  <div class="code"><pre>[root@localhost ~]# scp /etc/krb5.keytab root@krb2.home.bedroomprogrammers.net:/etc/krb5.keytab
</pre></div>
</div>

<p>At this point you&#39;ll want to restart the master&#39;s service and then start up the
kdc on the slave server:</p>
<div class="CodeRay">
  <div class="code"><pre>[root@slave ~]# chkconfig krb5kdc start
[root@slave ~]# /etc/init.d/krb5kdc start
</pre></div>
</div>

<p>Once the Slave is setup you&#39;ll need to modify the <code>/etc/krb5.conf</code> on the
client machines and the master machine to include the FQDN of the slave in the
<code>[realms]</code> section for the appropriate domain. The <code>[realms]</code> section would
then look like:</p>
<div class="CodeRay">
  <div class="code"><pre>[realms]
  BEDROOMPROGRAMMERS.NET = {
    kdc = kdc1.home.bedroomprogrammers.net
    kdc = kdc2.home.bedroomprogrammers.net
    admin_server = kdc1.home.bedroomprogrammers.net
  }
</pre></div>
</div>

<h2>Adding a New Host to the Domain</h2>

<p>Hosts need <code>krb5-workstation</code> and <code>krb5-libs</code> installed. Make sure the client
firewall rules have been applied.</p>

<p>Be sure to copy the config file <code>/etc/krb5.conf</code> mentioned on this page to each
client machine.</p>
<div class="CodeRay">
  <div class="code"><pre>[root@kerb-client ~]# kadmin -p &lt;&lt;username&gt;&gt;/admin
kadmin:  addprinc -randkey host/&lt;&lt;FQDN&gt;&gt;
kadmin:  ktadd -k /etc/krb5.keytab host/&lt;&lt;FQDN&gt;&gt;
</pre></div>
</div>

<p>You&#39;ll need to replace &lt;<FQDN>&gt; with the domain name of the host you&#39;re adding.
It will need a DNS entry matching this hostname.</p>

<h2>Firewall Configuration</h2>

<h3>Server Adjustments</h3>
<div class="CodeRay">
  <div class="code"><pre># Allow authentication to the KDC
-A INPUT -m tcp -p tcp --dport 88 -j ACCEPT
# Allow remote kerberos administration. This should probably be restricted more
-A INPUT -m tcp -p tcp --dport 749 -j ACCEPT
</pre></div>
</div>

<h3>Client Adjustments</h3>
<div class="CodeRay">
  <div class="code"><pre># Allow authentication to the KDC
-A OUTPUT -m tcp -p tcp --dport 88 -j ACCEPT
</pre></div>
</div>

<p>Setting up a client machine to talk to the KDC will initially require this rule
as well:</p>
<div class="CodeRay">
  <div class="code"><pre># Temporarily need this to setup the connection with the KDC
-A OUTPUT -m tcp -p tcp --dport 749 -j ACCEPT
</pre></div>
</div>

<h2>Configuration Files</h2>

<h3>/etc/krb5.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>[logging]
  default = FILE:/var/log/krb5libs.log
  kdc = FILE:/var/log/krb5kdc.log
  admin_server = FILE:/var/log/kadmind.log

[libdefaults]
  default_realm = BEDROOMPROGRAMMERS.NET
  dns_lookup_realm = false
  dns_lookup_kdc = false
  ticket_lifetime = 24h
  renew_lifetime = 3d
  forwardable = true

[realms]
  BEDROOMPROGRAMMERS.NET = {
    kdc = kdc1.home.bedroomprogrammers.net
    admin_server = kdc1.home.bedroomprogrammers.net
  }

[domain_realm]
  .bedroomprogrammers.net = BEDROOMPROGRAMMERS.NET
  bedroomprogrammers.net = BEDROOMPROGRAMMERS.NET
  .home.bedroomprogrammers.net = BEDROOMPROGRAMMERS.NET
  home.bedroomprogrammers.net = BEDROOMPROGRAMMERS.NET
</pre></div>
</div>

<h3>/var/kerberos/krb5kdc/kadm5.acl</h3>
<div class="CodeRay">
  <div class="code"><pre>*/admin@BEDROOMPROGRAMMERS.NET  *
</pre></div>
</div>

<h3>/var/kerberos/krb5kdc/kdc.conf</h3>
<div class="CodeRay">
  <div class="code"><pre>[kdcdefaults]
  kdc_ports = 88
  kdc_tcp_ports = 88

[realms]
  BEDROOMPROGRAMMERS.NET = {
    master_key_type = aes256-cts
    acl_file = /var/kerberos/krb5kdc/kadm5.acl
    dict_file = /usr/share/dict/words
    admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab
    supported_enctypes = aes256-cts:normal aes128-cts:normal 
  }
</pre></div>
</div>

<h2>References</h2>

<ul>
<li><a href="http://cryptnet.net/fdp/admin/kerby-infra/en/kerby-infra.html#configure">Kerberos Infrastructure Howto</a></li>
<li><a href="http://linsec.ca/Using_Kerberos_5_for_Single_Sign-On_Authentication">http://linsec.ca/Using_Kerberos_5_for_Single_Sign-On_Authentication</a></li>
</ul>

<h2>Notes on Cached Client Login</h2>

<ul>
<li><a href="http://redhatcat.blogspot.com/2008/07/caching-kerberos-credentials-for.html">http://redhatcat.blogspot.com/2008/07/caching-kerberos-credentials-for.html</a></li>
<li><a href="http://ubuntuforums.org/showthread.php?t=1205604">http://ubuntuforums.org/showthread.php?t=1205604</a></li>
<li><a href="http://www.techrepublic.com/blog/opensource/authentication-caching-with-nscd/127">http://www.techrepublic.com/blog/opensource/authentication-caching-with-nscd/127</a></li>
<li><a href="http://people.skolelinux.org/pere/blog/Caching_password__user_and_group_on_a_roaming_Debian_laptop.html">http://people.skolelinux.org/pere/blog/Caching_password__user_and_group_on_a_roaming_Debian_laptop.html</a></li>
</ul>

    </div>
  </body>
</html>
