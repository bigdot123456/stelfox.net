<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Trim - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Trim" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/trim/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Trim</h1>

<h2>Configuring</h2>

<p>This page is referring to TRIM support for SSDs. To enable it add
<code>noatime,discard</code> to the options on all of the fstab partition entries that
live on the drive. Be sure to disable any swap partitions that live on that
drive as well.</p>

<h3>Note on Encrypted Drives</h3>

<p>Turning TRIM support on for an encrypted hard drive will not actually do
anything. <code>discard</code> is a file system level option and full disk encryption
lives below that. It makes sense that it doesn&#39;t work, writing a sector full of
0s to an encrypted partition will result in a sector of encrypted 0s which will
look more or less like random garbage.</p>

<p>There is a trick to allow this to work but I&#39;m not will to go that route due to
the security implications of allowing attackers to see where the data lives on
my hard drive and where it doesn&#39;t, but for completeness, I&#39;m documenting
(untested) what needs to be done to enable this.</p>

<p>You&#39;ll need to replace <your_device> with the DM mapper crypted partition such
as <code>/dev/mapper/vg_desktop-lv_root</code>. You&#39;ll want to do this for all of the
encrypted partitions on the drive.</p>
<div class="CodeRay">
  <div class="code"><pre>dmsetup table &lt;your_device&gt; --showkeys
dmsetup load &lt;your_device&gt; --&quot;&lt;line above&gt; 1 allow_discards&quot;
dmsetup resume &lt;your_device&gt;
</pre></div>
</div>

<p>Even without TRIM support noatime and no swap partitions are still good
performance improvements.</p>

<h2>Testing</h2>

<p>This requires you install the <code>hdparm</code> package on Fedora.</p>

<p>To test and make sure that trim support is working, make sure you&#39;re in a
directory that lives on a partition on the SSD, then create a test file like
so:</p>
<div class="CodeRay">
  <div class="code"><pre>seq 1 1000 &gt; trimtest
sync
hdparm --fibmap trimtest
</pre></div>
</div>

<p>You will get output like this:</p>
<div class="CodeRay">
  <div class="code"><pre>trimtest:
 filesystem blocksize 4096, begins at LBA 0; assuming 512 byte sectors.
 byte_offset  begin_LBA    end_LBA    sectors
           0   25565616   25565623          8
</pre></div>
</div>

<p>The important thing to take into account is the <code>begin_LBA</code> column make note of
this number and use it in place in the following commands. You&#39;ll need to
replace <code>/dev/sda</code> with the device name matching your SSD.</p>
<div class="CodeRay">
  <div class="code"><pre>hdparm --read-sector 25565616 /dev/sda
</pre></div>
</div>

<p>You&#39;ll receive output that looks a lot like the following:</p>
<div class="CodeRay">
  <div class="code"><pre>/dev/sda:
reading sector 25565616: succeeded
bb2d 06dc 87c3 6bb6 c43c fab7 a0a9 12db
9e35 2246 4ae3 9eaf 373e 3ce3 ea75 2657
4bb9 e299 c9cf eee9 c74b bb86 9b25 b36c
5214 bf13 7f2b 0cf3 9866 6b7e 0344 8f33
4ea4 0cdc 6ad3 f3e2 8a72 4032 b0d5 7c8c
2002 82cc d631 6f80 0967 e698 5e7c b9c3
c660 9953 ed1e 832f 29a2 7c46 5fab f7e0
8705 6c74 10d2 3649 6b4c 136e e3ba b36f
21dd f96e 9d7c 7c9e 8596 0c0b 67df 76fe
6797 608c 0f42 145e b381 4efe 754f bd59
8575 d75e 95b0 7281 f454 c364 43ab 11dd
79a4 e3b2 1b11 67fa ec04 5d73 6ed9 d77b
bebe 3df2 086c 26e3 ac8e c6b3 0591 370f
5c9c ec7f 777e 15de 23e0 d432 5b8a 460a
132c d09c a81d 3683 79ff c7de 4631 f88f
fa53 5aa6 0286 1817 0dde 85c8 84bc 3a03
f8b1 60eb e1ca 5f1e 2094 eba9 ec61 6fe8
7214 1a0c 88e1 4dac 5f3c f3b7 9d29 7dfd
2c2a 6539 a675 a755 482b 31c8 755c 832c
e166 25b9 539d e0a2 2360 217b 79ec a7d9
9930 e7a7 3af7 d318 83aa 1098 81c2 161f
e55c 6c45 4641 b4e8 8aeb 58e3 e199 74d5
b6ff 93a1 da35 11e9 c3f3 e84d 10e8 ee5b
094f f905 af0e 2872 a683 4836 9d7b 1dba
c528 e972 f72d 1575 a116 bc3d 44b4 970c
db54 690e 2434 3c4e 9eec 2b60 6ccf 4765
6f90 b0bc 7f15 9bd5 6213 3b4b c477 9972
cb27 d777 afcb d95e 1528 2ecd 5d2e 63c9
a25e 9132 39af dab4 81db ea9e a168 204e
f162 8616 7c6a c7e3 bdb2 cb5c 7620 fd43
17af b869 978d 6b58 c54f fdc9 8a37 01d2
f82e b721 631b 3888 bb27 874c 872a 28e0
</pre></div>
</div>

<p>Now we&#39;ll remove the file, sync the filesystem and check that sector again:</p>
<div class="CodeRay">
  <div class="code"><pre>rm -f trimtest
sync
hdparm --read-sector 25565616 /dev/sda
</pre></div>
</div>

<p>If trim support is working the sector read should be all 0s.</p>

    </div>
  </body>
</html>
