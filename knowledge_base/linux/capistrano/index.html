<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Capistrano - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Capistrano" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/linux/capistrano/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git https://io.stelfox.net/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Capistrano</h1>

<p>One liner virt-install script to setup a libvirt machine.</p>
<div class="CodeRay">
  <div class="code"><pre>virt-install --connect qemu:///system --name captest --ram 4096 \
  --arch x86_64 --vcpus 2 --security type=dynamic \
  --location http://mirrors.kernel.org/fedora/releases/18/Fedora/x86_64/os/ \
  --extra-args &quot;text console=ttyS0 ks=http://stelfox.net/ks-lxc.cfg&quot; \
  --os-type=linux --os-variant=fedora18 \
  --disk=&quot;pool=default,size=15,sparse=true,format=qcow2&quot; \
  --network=&quot;network=default,mac=00:07:3e:22:33:44&quot; --graphics=none --hvm \
  --virt-type=kvm --accelerate --console=pty --memballoon=virtio --autostart \
  --check-cpu
</pre></div>
</div>

<p>Login as root</p>
<div class="CodeRay">
  <div class="code"><pre>useradd deploy
passwd deploy
</pre></div>
</div>

<p>On your laptop</p>
<div class="CodeRay">
  <div class="code"><pre>ssh-copy-id deploy@tgt
</pre></div>
</div>

<p>Back as root</p>
<div class="CodeRay">
  <div class="code"><pre>passwd -l deploy
yum install git tar ruby rubygem-bundler ruby-devel make gcc gcc-c++ -y
</pre></div>
</div>

<p>If using sqlite3...</p>
<div class="CodeRay">
  <div class="code"><pre>yum install sqlite-devel -y
</pre></div>
</div>

<p>Testing git/ssh access (back on laptop):</p>
<div class="CodeRay">
  <div class="code"><pre>ssh -A deploy@192.168.122.40 'git ls-remote git@github.com:sstelfox/parcel_pot.git'
</pre></div>
</div>

<p>This didnt work the first time since I didnt have githubs host key added to my
<code>known_hosts</code> file. After logging in directly, running the command, and
accepting the host key it worked fine.</p>

<p>And back as root:</p>

<p>Since I switched to using the deploy users home directory I dont need to
perform the following block of commands at all...</p>
<div class="CodeRay">
  <div class="code"><pre>mkdir -p /var/www/parcel_pot/{releases,shared}
restorecon -R /var/www
chown -R deploy:deploy /var/www/parcel_pot

# All files created in this directory will have the deploy group set
chmod 2755 /var/www/parcel_pot
chmod -R u=rwX,g=rwX,o= /var/www/parcel_pot

# This is only needed if you want to use foreman to create and update system
# init scripts
groupadd -g 401 sudoers
usermod -a -G sudoers deploy
# The following should be more heavily restricted
echo 'Cmnd_Alias FOREMAN = /home/deploy/*/current/bin/foreman, /usr/bin/systemctl' &gt;&gt; /etc/sudoers
echo '%sudoers  ALL=(ALL)  NOPASSWD: FOREMAN' &gt;&gt; /etc/sudoers
</pre></div>
</div>

<p>Back in the project ran:</p>
<div class="CodeRay">
  <div class="code"><pre>cap staging deploy:check
cap staging deploy
</pre></div>
</div>

    </div>
  </body>
</html>
