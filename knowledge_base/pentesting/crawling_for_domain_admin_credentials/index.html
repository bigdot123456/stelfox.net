<!DOCTYPE html>
<html lang='en_US'>
  <head>
    <title>Crawling for Domain Admin Credentials - Stelfox Athen&#xe6;um</title>

    <meta http-equiv='content-type' content='text/html; charset=utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1' />
    
    

    <link rel="alternate" type="application/atom+xml" title="Stelfox Athen&#xe6;um Feed" href="/atom.xml" />
    <link rel="canonical" href="https://stelfox.net" />
    <link rel="author" href="https://plus.google.com/+SamStelfox31337/"/>

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Crawling for Domain Admin Credentials" />
    <meta property="og:url" content="https://stelfox.net/knowledge_base/pentesting/crawling_for_domain_admin_credentials/" />
    <meta property="og:site_name" content="Stelfox Athen&#xe6;um" />
    <meta property="article:publisher" content="https://www.facebook.com/sstelfox" />
    <meta property="og:image" content="https://stelfox.net/static/avatar-01.jpg" />

    <meta name="go-import" content="stelfox.net git io:repos/" />

    <link rel='stylesheet' href="//fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Alegreya+SC:700" />
    <link rel="stylesheet" href="https://stelfox.net/css/3HrCRVwL3Gos2V4HzXAw/Om/nxs=.css" />

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-32188490-1', 'stelfox.net');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class='masthead'>
      <div class='masthead-inner'>
        <h1><a href='/' title='Home'>Sam Stelfox</a></h1>
        <p class='lead'>Thoughts from a systems hacker and developer.</p>
        <nav>
          <ul>
            <li><a href="/about/" title="About">About</a></li>
            <li><a href="/blog/" title="Blog">Blog</a></li>
            <li><a href="/knowledge_base/" title="Knowledge Base">Knowledge Base</a></li>
            <li><form action="/search/" method="get"><input type="search" name="q" placeholder="Search" /></form></li>
          </ul>
        </nav>
        <footer class='colophon'>
          <p>&copy; 2014, All rights reserved.</p>
        </footer>
      </div>
    </header>
    <div class='content container'>
      <h1>Crawling for Domain Admin Credentials</h1>

<p>Some folks are just doing it right. Not using their admin credentials for
everyday activities. While this is a best practice, it doesn&#39;t prevent the
exploitation of domain administrator privileges, it just makes it harder. At
some point, the domain administrator is going to have to, well, administer to
the domain. It&#39;s at that point that we want to catch the victim using their
Domain Administrator credentials.</p>

<p>The scenario is this. You&#39;ve used a tool such as NBTEnum to enumerate Domain
Admin account names. You&#39;ve also managed to gain Local Administrator
credentials by dumping and cracking the hashes of a vulnerable system on the
network. Like most of corporate America, the target organization is using a
universal Local Administrator account across most of their enterprise. You are
able to freely move around the network, gaining access to individual systems.
While this is fairly deep penetration, you want the keys to the kingdom, or as
Josh Wright would call them, the &quot;family jewels&quot;: Domain Administrator. What
the organization is doing right, is not using their Domain Admin credentials
for daily activities. This makes things a little tougher. You know it&#39;s only a
matter of time until you find the right system to elevate your privileges, but
it&#39;s late in the pentest and time is of the essence. Enter the following
command, the Domain Process Crawler:</p>
<div class="CodeRay">
  <div class="code"><pre>FOR /F %i in (ips.txt) DO @echo [+] %i &amp;&amp; @tasklist /V /S %i /U user /P password 2&gt;NUL &gt; output.txt
FOR /F %n in (names.txt) DO @type output.txt | findstr %n &gt; NUL
echo [!] %n was found running a process on %i
pause
</pre></div>
</div>

<p>What this command does, is take a file containing a list of ip addresses
(ips.txt) and runs tasklist against each one, redirecting the output to a text
file (output.txt). For each ip, the command checks the output for the existence
of a string matching one of a list of usernames from another text file
(names.txt). If it finds a match, it reports the match to the user and pauses,
giving the user the option to continue.</p>

<p>With this command, you can easily crawl an entire domain for a running process
executed by one of the Domain Administrator accounts you discovered via
NBTEnum. When you find one, simply psexec your way to the system as Local
Administrator, impersonate the Domain Administrator using the token on the box,
and create your own shiny, new Domain Administrator credentials. If you have
the Metasploit Framework installed on the system and want to take it a step
further, you could use msfcli to automagically psexec yourself a shell when the
command finds the right process, rather than pause.</p>

<p>Like the scenario states, there is some work to be done before this command is
useful. You&#39;ll need an initial shell and a little luck.</p>

    </div>
  </body>
</html>
